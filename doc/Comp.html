<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>module Comp - RDoc Documentation</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script src="./js/jquery.js"></script>
<script src="./js/darkfish.js"></script>

<link href="./css/fonts.css" rel="stylesheet">
<link href="./css/rdoc.css" rel="stylesheet">



<body id="top" role="document" class="module">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="./index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="./table_of_contents.html#pages">Pages</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    
    
    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li ><a href="#method-c-compare_total_for">::compare_total_for</a>
    
    <li ><a href="#method-c-create_compare_months_sheet">::create_compare_months_sheet</a>
    
    <li ><a href="#method-c-create_compare_sheet">::create_compare_sheet</a>
    
    <li ><a href="#method-c-create_inactive_sheets">::create_inactive_sheets</a>
    
    <li ><a href="#method-c-create_monthly_sheet">::create_monthly_sheet</a>
    
    <li ><a href="#method-c-create_remainder_sheet">::create_remainder_sheet</a>
    
    <li ><a href="#method-c-create_sales_per_city_sheet">::create_sales_per_city_sheet</a>
    
    <li ><a href="#method-c-create_share_sheet">::create_share_sheet</a>
    
    <li ><a href="#method-c-create_top_terminals_sheet">::create_top_terminals_sheet</a>
    
    <li ><a href="#method-c-create_weekly_sheet">::create_weekly_sheet</a>
    
    <li ><a href="#method-c-get_sales">::get_sales</a>
    
    <li ><a href="#method-c-last_day_of_month">::last_day_of_month</a>
    
    <li ><a href="#method-c-month_ago">::month_ago</a>
    
    <li ><a href="#method-c-year_ago">::year_ago</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="module-Comp">
  <h1 id="module-Comp" class="module">
    module Comp
  </h1>

  <section class="description">
    
  </section>

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    
    <section class="constants-list">
      <header>
        <h3>Constants</h3>
      </header>
      <dl>
      
        <dt id="GAME_TYPES_MK">GAME_TYPES_MK
        
        <dd>
        
      
        <dt id="MONTH_NAMES_MK">MONTH_NAMES_MK
        
        <dd>
        
      
        <dt id="MPM_PERC">MPM_PERC
        
        <dd>
        
      
        <dt id="RM_PERC">RM_PERC
        
        <dd>
        
      
        <dt id="TOP_COUNT">TOP_COUNT
        
        <dd>
        
      
        <dt id="VERSION">VERSION
        
        <dd>
        
      
      </dl>
    </section>
    

    

    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Class Methods</h3>
       </header>

    
      <div id="method-c-compare_total_for" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">compare_total_for</span><span
            class="method-args">(sheet, sales, row, col)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="compare_total_for-source">
            <pre><span class="ruby-comment"># File lib/comp/utils.rb, line 320</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">compare_total_for</span> <span class="ruby-identifier">sheet</span>, <span class="ruby-identifier">sales</span>, <span class="ruby-identifier">row</span>, <span class="ruby-identifier">col</span>
  <span class="ruby-identifier">bold_font</span> =  <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;droid sans&#39;</span>, <span class="ruby-identifier">bold</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>) 
  <span class="ruby-identifier">total_fmt</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,
                <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">bold_font</span>)

  <span class="ruby-identifier">lotto</span> = { }
  <span class="ruby-identifier">lotto</span>[<span class="ruby-value">:money</span>] = <span class="ruby-identifier">sales</span>.<span class="ruby-identifier">inject</span>(<span class="ruby-value">0</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">sum</span>, <span class="ruby-identifier">s</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">is_instant</span> <span class="ruby-operator">!=</span> <span class="ruby-value">1</span> <span class="ruby-keyword">then</span> <span class="ruby-identifier">sum</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">sales</span> <span class="ruby-keyword">else</span> <span class="ruby-identifier">sum</span> <span class="ruby-keyword">end</span> }
  <span class="ruby-identifier">lotto</span>[<span class="ruby-value">:columns</span>] = <span class="ruby-identifier">sales</span>.<span class="ruby-identifier">inject</span>(<span class="ruby-value">0</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">sum</span>, <span class="ruby-identifier">s</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">is_instant</span> <span class="ruby-operator">!=</span> <span class="ruby-value">1</span> <span class="ruby-keyword">then</span> <span class="ruby-identifier">sum</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">qty</span> <span class="ruby-keyword">else</span> <span class="ruby-identifier">sum</span> <span class="ruby-keyword">end</span> }
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row</span>)[<span class="ruby-identifier">col</span>] = <span class="ruby-string">&#39;лото&#39;</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">col</span>, <span class="ruby-identifier">total_fmt</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row</span>)[<span class="ruby-identifier">col</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>] = <span class="ruby-identifier">lotto</span>[<span class="ruby-value">:money</span>]
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">col</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>, <span class="ruby-identifier">total_fmt</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row</span>)[<span class="ruby-identifier">col</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>] = <span class="ruby-identifier">lotto</span>[<span class="ruby-value">:columns</span>]
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">col</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>, <span class="ruby-identifier">total_fmt</span>
  
  <span class="ruby-identifier">instants</span> = { }
  <span class="ruby-identifier">instants</span>[<span class="ruby-value">:money</span>] = <span class="ruby-identifier">sales</span>.<span class="ruby-identifier">inject</span>(<span class="ruby-value">0</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">sum</span>, <span class="ruby-identifier">s</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">is_instant</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-keyword">then</span> <span class="ruby-identifier">sum</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">sales</span> <span class="ruby-keyword">else</span> <span class="ruby-identifier">sum</span> <span class="ruby-keyword">end</span> }
  <span class="ruby-identifier">instants</span>[<span class="ruby-value">:tickets</span>] = <span class="ruby-identifier">sales</span>.<span class="ruby-identifier">inject</span>(<span class="ruby-value">0</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">sum</span>, <span class="ruby-identifier">s</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">is_instant</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-keyword">then</span> <span class="ruby-identifier">sum</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">qty</span> <span class="ruby-keyword">else</span> <span class="ruby-identifier">sum</span> <span class="ruby-keyword">end</span> }
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>)[<span class="ruby-identifier">col</span>] = <span class="ruby-string">&#39;инстанти&#39;</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">col</span>, <span class="ruby-identifier">total_fmt</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>)[<span class="ruby-identifier">col</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>] = <span class="ruby-identifier">instants</span>[<span class="ruby-value">:money</span>]
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">col</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>, <span class="ruby-identifier">total_fmt</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>)[<span class="ruby-identifier">col</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>] = <span class="ruby-identifier">instants</span>[<span class="ruby-value">:tickets</span>]
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">col</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>, <span class="ruby-identifier">total_fmt</span>
  
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>)[<span class="ruby-identifier">col</span>] = <span class="ruby-string">&#39;вкупно&#39;</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">col</span>, <span class="ruby-identifier">total_fmt</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>)[<span class="ruby-identifier">col</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>] = <span class="ruby-identifier">lotto</span>[<span class="ruby-value">:money</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">instants</span>[<span class="ruby-value">:money</span>]
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">col</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>, <span class="ruby-identifier">total_fmt</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-create_compare_months_sheet" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">create_compare_months_sheet</span><span
            class="method-args">(book, day)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Compare months sheet</p>
          
          

          
          <div class="method-source-code" id="create_compare_months_sheet-source">
            <pre><span class="ruby-comment"># File lib/comp/utils.rb, line 1038</span>
<span class="ruby-keyword">def</span> <span class="ruby-constant">Comp</span>.<span class="ruby-identifier">create_compare_months_sheet</span> <span class="ruby-identifier">book</span>, <span class="ruby-identifier">day</span>
  <span class="ruby-comment"># 1st we get the sales for A: current month, B: previous month, C: a year ago</span>
  <span class="ruby-identifier">qry</span> =<span class="ruby-value">&lt;&lt;-EOT
    g.id                    AS game_id,
    g.name                  AS name,
    g.price                 AS price,
    CASE 
      WHEN g.type = &#39;INSTANT&#39; THEN 1
      ELSE 0
    END                     AS is_instant,
    CASE
      WHEN g.parent IS NOT NULL THEN g.parent
      ELSE g.id
    END                     AS parent_id,
    SUM(s.sales)            AS sales,
    SUM(s.sales) / g.price  AS qty,
    COUNT(DISTINCT t.id)    AS term_count
  EOT</span>
  
  <span class="ruby-comment"># use same pattern for date interval</span>
  <span class="ruby-identifier">day_b</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">day</span>.<span class="ruby-identifier">month</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-comment"># month before</span>
            <span class="ruby-constant">Date</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">day</span>.<span class="ruby-identifier">year</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>, <span class="ruby-value">12</span>, <span class="ruby-value">1</span>
          <span class="ruby-keyword">else</span>
            <span class="ruby-constant">Date</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">day</span>.<span class="ruby-identifier">year</span>, <span class="ruby-identifier">day</span>.<span class="ruby-identifier">month</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>, <span class="ruby-value">1</span>
          <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">day_c</span> = <span class="ruby-constant">Date</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">day</span>.<span class="ruby-identifier">year</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>, <span class="ruby-identifier">day</span>.<span class="ruby-identifier">month</span>, <span class="ruby-value">1</span> <span class="ruby-comment"># year before (same month)</span>

  <span class="ruby-identifier">sales</span> = <span class="ruby-constant">Sale</span>.<span class="ruby-identifier">select</span>(<span class="ruby-identifier">qry</span>).
        <span class="ruby-identifier">joins</span>(<span class="ruby-string">&#39;AS s INNER JOIN games AS g ON s.game_id = g.id&#39;</span>).
        <span class="ruby-identifier">joins</span>(<span class="ruby-string">&#39;INNER JOIN terminals AS t ON s.terminal_id = t.id&#39;</span>)

  <span class="ruby-comment"># A:</span>
  <span class="ruby-identifier">sales_a</span> = <span class="ruby-identifier">sales</span>.      
        <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;s.date BETWEEN date(:day, &#39;start of month&#39;) AND date(:day,&#39;start of month&#39;,&#39;+1 month&#39;,&#39;-1 day&#39;)&quot;</span>, <span class="ruby-identifier">day</span><span class="ruby-operator">:</span> <span class="ruby-identifier">day</span>). 
        <span class="ruby-identifier">group</span>(<span class="ruby-string">&#39;g.id&#39;</span>).
        <span class="ruby-identifier">having</span>(<span class="ruby-string">&#39;qty &gt; 0&#39;</span>).
        <span class="ruby-identifier">order</span>(<span class="ruby-string">&#39;is_instant, parent_id, g.id&#39;</span>)

  <span class="ruby-comment"># B:</span>
  <span class="ruby-identifier">sales_b</span> = <span class="ruby-identifier">sales</span>.      
        <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;s.date BETWEEN date(:day, &#39;start of month&#39;) AND date(:day,&#39;start of month&#39;,&#39;+1 month&#39;,&#39;-1 day&#39;)&quot;</span>, <span class="ruby-identifier">day</span><span class="ruby-operator">:</span> <span class="ruby-identifier">day_b</span>). 
        <span class="ruby-identifier">group</span>(<span class="ruby-string">&#39;g.id&#39;</span>).
        <span class="ruby-identifier">having</span>(<span class="ruby-string">&#39;qty &gt; 0&#39;</span>).
        <span class="ruby-identifier">order</span>(<span class="ruby-string">&#39;is_instant, parent_id, g.id&#39;</span>)

  <span class="ruby-comment"># C:</span>
  <span class="ruby-identifier">sales_c</span> = <span class="ruby-identifier">sales</span>.      
        <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;s.date BETWEEN date(:day, &#39;start of month&#39;) AND date(:day,&#39;start of month&#39;,&#39;+1 month&#39;,&#39;-1 day&#39;)&quot;</span>, <span class="ruby-identifier">day</span><span class="ruby-operator">:</span> <span class="ruby-identifier">day_c</span>). 
        <span class="ruby-identifier">group</span>(<span class="ruby-string">&#39;g.id&#39;</span>).
        <span class="ruby-identifier">having</span>(<span class="ruby-string">&#39;qty &gt; 0&#39;</span>).
        <span class="ruby-identifier">order</span>(<span class="ruby-string">&#39;is_instant, parent_id, g.id&#39;</span>)

  <span class="ruby-identifier">sheet</span> = <span class="ruby-identifier">book</span>.<span class="ruby-identifier">create_worksheet</span> <span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;Споредба на месеци&#39;</span> 

  <span class="ruby-comment"># worksheet default format</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">default_format</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>)

  <span class="ruby-comment"># default foramts for </span>
  <span class="ruby-identifier">sales_fmt</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,
                <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>)
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>( <span class="ruby-value">3</span>).<span class="ruby-identifier">default_format</span> = <span class="ruby-identifier">sales_fmt</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>( <span class="ruby-value">4</span>).<span class="ruby-identifier">default_format</span> = <span class="ruby-identifier">sales_fmt</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>( <span class="ruby-value">9</span>).<span class="ruby-identifier">default_format</span> = <span class="ruby-identifier">sales_fmt</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">10</span>).<span class="ruby-identifier">default_format</span> = <span class="ruby-identifier">sales_fmt</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">15</span>).<span class="ruby-identifier">default_format</span> = <span class="ruby-identifier">sales_fmt</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">16</span>).<span class="ruby-identifier">default_format</span> = <span class="ruby-identifier">sales_fmt</span>

  <span class="ruby-comment"># fix some columns widths</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">width</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">6</span>).<span class="ruby-identifier">width</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">12</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">3</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">width</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">7</span>).<span class="ruby-identifier">width</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">13</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">20</span>

  <span class="ruby-comment"># title format</span>
  <span class="ruby-identifier">title_fmt</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">weight</span><span class="ruby-operator">:</span> <span class="ruby-value">:bold</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, 
            <span class="ruby-identifier">text_wrap</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>, <span class="ruby-identifier">vertical_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:middle</span>, <span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>,
            <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>, <span class="ruby-identifier">bold</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>, <span class="ruby-identifier">size</span><span class="ruby-operator">:</span> <span class="ruby-value">12</span>)
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">height</span> = <span class="ruby-value">20</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">0</span>)[<span class="ruby-value">0</span>] = <span class="ruby-node">&quot;#{ MONTH_NAMES_MK[day.month] } #{ day.year }&quot;</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-value">0</span>, <span class="ruby-identifier">title_fmt</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">merge_cells</span> <span class="ruby-value">0</span>, <span class="ruby-value">0</span>, <span class="ruby-value">0</span>, <span class="ruby-value">4</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">0</span>)[<span class="ruby-value">6</span>] = <span class="ruby-node">&quot;#{ MONTH_NAMES_MK[day_b.month] } #{ day_b.year }&quot;</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-value">6</span>, <span class="ruby-identifier">title_fmt</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">merge_cells</span> <span class="ruby-value">0</span>, <span class="ruby-value">6</span>, <span class="ruby-value">0</span>, <span class="ruby-value">10</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">0</span>)[<span class="ruby-value">12</span>] = <span class="ruby-node">&quot;#{ MONTH_NAMES_MK[day_c.month] } #{ day_c.year }&quot;</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-value">12</span>, <span class="ruby-identifier">title_fmt</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">merge_cells</span> <span class="ruby-value">0</span>, <span class="ruby-value">12</span>, <span class="ruby-value">0</span>, <span class="ruby-value">16</span>

  <span class="ruby-identifier">heading_fmt</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">weight</span><span class="ruby-operator">:</span> <span class="ruby-value">:bold</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, 
            <span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">text_wrap</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>, <span class="ruby-identifier">vertical_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:middle</span>, 
            <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>, <span class="ruby-identifier">bold</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>)
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">push</span> <span class="ruby-operator">*</span>[ <span class="ruby-string">&quot;id&quot;</span>, <span class="ruby-string">&quot;игра&quot;</span>, <span class="ruby-string">&quot;бр.\nтерм.&quot;</span>, <span class="ruby-string">&quot;уплата&quot;</span>, <span class="ruby-string">&quot;комб./\nтикети.&quot;</span>, <span class="ruby-string">&quot;&quot;</span>,
                       <span class="ruby-string">&quot;id&quot;</span>, <span class="ruby-string">&quot;игра&quot;</span>, <span class="ruby-string">&quot;бр.\nтерм.&quot;</span>, <span class="ruby-string">&quot;уплата&quot;</span>, <span class="ruby-string">&quot;комб./\nтикети.&quot;</span>, <span class="ruby-string">&quot;&quot;</span>,
                       <span class="ruby-string">&quot;id&quot;</span>, <span class="ruby-string">&quot;игра&quot;</span>, <span class="ruby-string">&quot;бр.\nтерм.&quot;</span>, <span class="ruby-string">&quot;уплата&quot;</span>, <span class="ruby-string">&quot;комб./\nтикети.&quot;</span>, <span class="ruby-string">&quot;&quot;</span>,
                     ]
  <span class="ruby-value">0</span>.<span class="ruby-identifier">upto</span>(<span class="ruby-value">4</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">c</span>     , <span class="ruby-identifier">heading_fmt</span>
    <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">c</span> <span class="ruby-operator">+</span>  <span class="ruby-value">6</span>, <span class="ruby-identifier">heading_fmt</span>
    <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">c</span> <span class="ruby-operator">+</span> <span class="ruby-value">12</span>, <span class="ruby-identifier">heading_fmt</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">height</span> = <span class="ruby-value">24</span>

  <span class="ruby-comment"># Formating</span>
  <span class="ruby-identifier">font</span>      =  <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>) 
  <span class="ruby-identifier">bold_font</span> =  <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>, <span class="ruby-identifier">bold</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>) 
  <span class="ruby-identifier">line_fmt</span>  = [
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:left</span>,  <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,   <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span>  <span class="ruby-string">&#39;#,###&#39;</span>,   <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span>  <span class="ruby-string">&#39;#,###&#39;</span>,   <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
  ]
  <span class="ruby-identifier">lastln_fmt</span>  = [
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:left</span>,  <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,
      <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,
      <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,
      <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
  ]

  <span class="ruby-identifier">total_fmt</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,
                <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">bold_font</span>)

  <span class="ruby-identifier">sales_a</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">s</span>, <span class="ruby-identifier">idx</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">r</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span> <span class="ruby-value">2</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">idx</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-value">0</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">game_id</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-value">1</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">name</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-value">2</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">term_count</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-value">3</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">sales</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-value">4</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">qty</span>

    <span class="ruby-identifier">ln_fmt</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">idx</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">sales_a</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span> <span class="ruby-keyword">then</span> <span class="ruby-identifier">lastln_fmt</span> <span class="ruby-keyword">else</span> <span class="ruby-identifier">line_fmt</span> <span class="ruby-keyword">end</span>
    <span class="ruby-value">0</span>.<span class="ruby-identifier">upto</span>(<span class="ruby-value">4</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">i</span>, <span class="ruby-identifier">ln_fmt</span>[<span class="ruby-identifier">i</span>] }
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">2</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sales_a</span>.<span class="ruby-identifier">length</span>)[<span class="ruby-value">3</span>] = <span class="ruby-identifier">sales_a</span>.<span class="ruby-identifier">inject</span>(<span class="ruby-value">0</span>) {<span class="ruby-operator">|</span><span class="ruby-identifier">sum</span>, <span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sum</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">sales</span>}
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">2</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sales_a</span>.<span class="ruby-identifier">length</span>)[<span class="ruby-value">4</span>] = <span class="ruby-identifier">sales_a</span>.<span class="ruby-identifier">inject</span>(<span class="ruby-value">0</span>) {<span class="ruby-operator">|</span><span class="ruby-identifier">sum</span>, <span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sum</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">qty</span>}
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">2</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sales_a</span>.<span class="ruby-identifier">length</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-value">3</span>, <span class="ruby-identifier">total_fmt</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">2</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sales_a</span>.<span class="ruby-identifier">length</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-value">4</span>, <span class="ruby-identifier">total_fmt</span>

  <span class="ruby-identifier">off</span> = <span class="ruby-value">6</span>
  <span class="ruby-identifier">sales_b</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">s</span>, <span class="ruby-identifier">idx</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">r</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span> <span class="ruby-value">2</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">idx</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">0</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">game_id</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">name</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">term_count</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">3</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">sales</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">4</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">qty</span>

    <span class="ruby-identifier">ln_fmt</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">idx</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">sales_b</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span> <span class="ruby-keyword">then</span> <span class="ruby-identifier">lastln_fmt</span> <span class="ruby-keyword">else</span> <span class="ruby-identifier">line_fmt</span> <span class="ruby-keyword">end</span>
    <span class="ruby-value">0</span>.<span class="ruby-identifier">upto</span>(<span class="ruby-value">4</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">i</span>, <span class="ruby-identifier">ln_fmt</span>[<span class="ruby-identifier">i</span>] }
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">2</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sales_b</span>.<span class="ruby-identifier">length</span>)[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">3</span>] = <span class="ruby-identifier">sales_b</span>.<span class="ruby-identifier">inject</span>(<span class="ruby-value">0</span>) {<span class="ruby-operator">|</span><span class="ruby-identifier">sum</span>, <span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sum</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">sales</span>}
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">2</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sales_b</span>.<span class="ruby-identifier">length</span>)[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">4</span>] = <span class="ruby-identifier">sales_b</span>.<span class="ruby-identifier">inject</span>(<span class="ruby-value">0</span>) {<span class="ruby-operator">|</span><span class="ruby-identifier">sum</span>, <span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sum</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">qty</span>}
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">2</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sales_b</span>.<span class="ruby-identifier">length</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">3</span>, <span class="ruby-identifier">total_fmt</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">2</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sales_b</span>.<span class="ruby-identifier">length</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">4</span>, <span class="ruby-identifier">total_fmt</span>

  <span class="ruby-identifier">off</span> = <span class="ruby-value">12</span>
  <span class="ruby-identifier">sales_c</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">s</span>, <span class="ruby-identifier">idx</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">r</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span> <span class="ruby-value">2</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">idx</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">0</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">game_id</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">name</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">term_count</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">3</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">sales</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">4</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">qty</span>

    <span class="ruby-identifier">ln_fmt</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">idx</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">sales_c</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span> <span class="ruby-keyword">then</span> <span class="ruby-identifier">lastln_fmt</span> <span class="ruby-keyword">else</span> <span class="ruby-identifier">line_fmt</span> <span class="ruby-keyword">end</span>
    <span class="ruby-value">0</span>.<span class="ruby-identifier">upto</span>(<span class="ruby-value">4</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">i</span>, <span class="ruby-identifier">ln_fmt</span>[<span class="ruby-identifier">i</span>] }
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">2</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sales_c</span>.<span class="ruby-identifier">length</span>)[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">3</span>] = <span class="ruby-identifier">sales_c</span>.<span class="ruby-identifier">inject</span>(<span class="ruby-value">0</span>) {<span class="ruby-operator">|</span><span class="ruby-identifier">sum</span>, <span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sum</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">sales</span>}
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">2</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sales_c</span>.<span class="ruby-identifier">length</span>)[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">4</span>] = <span class="ruby-identifier">sales_c</span>.<span class="ruby-identifier">inject</span>(<span class="ruby-value">0</span>) {<span class="ruby-operator">|</span><span class="ruby-identifier">sum</span>, <span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sum</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">qty</span>}
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">2</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sales_c</span>.<span class="ruby-identifier">length</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">3</span>, <span class="ruby-identifier">total_fmt</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">2</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sales_c</span>.<span class="ruby-identifier">length</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">4</span>, <span class="ruby-identifier">total_fmt</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-create_compare_sheet" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">create_compare_sheet</span><span
            class="method-args">(book, day)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="create_compare_sheet-source">
            <pre><span class="ruby-comment"># File lib/comp/utils.rb, line 102</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">create_compare_sheet</span>(<span class="ruby-identifier">book</span>, <span class="ruby-identifier">day</span>)
  <span class="ruby-identifier">rounded_period</span> = {
    <span class="ruby-identifier">from</span><span class="ruby-operator">:</span> <span class="ruby-identifier">day</span> <span class="ruby-operator">-</span> (<span class="ruby-identifier">day</span>.<span class="ruby-identifier">day</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>),
    <span class="ruby-identifier">to</span><span class="ruby-operator">:</span>   <span class="ruby-identifier">day</span> <span class="ruby-operator">-</span> (<span class="ruby-identifier">day</span>.<span class="ruby-identifier">day</span> <span class="ruby-operator">%</span> <span class="ruby-value">7</span>)
  }

  <span class="ruby-identifier">qry</span> =<span class="ruby-value">&lt;&lt;-EOT
    g.id                    AS game_id,
    g.name                  AS name,
    CASE 
      WHEN g.type = &#39;INSTANT&#39; THEN 1
      ELSE 0
    END                     AS is_instant,
    CASE
      WHEN g.parent IS NOT NULL THEN g.parent
      ELSE g.id
    END                     AS parent_id,
    SUM(s.sales)            AS sales,
    SUM(s.sales) / g.price  AS qty
  EOT</span>
  <span class="ruby-identifier">sales</span> = <span class="ruby-constant">Sale</span>.<span class="ruby-identifier">select</span>(<span class="ruby-identifier">qry</span>).
        <span class="ruby-identifier">joins</span>(<span class="ruby-string">&#39;AS s INNER JOIN games AS g ON s.game_id = g.id&#39;</span>).
        <span class="ruby-identifier">joins</span>(<span class="ruby-string">&#39;INNER JOIN terminals AS t ON s.terminal_id = t.id&#39;</span>)
  <span class="ruby-identifier">sales_a</span> = <span class="ruby-identifier">sales</span>.      
        <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;s.date BETWEEN :from AND :to&quot;</span>, <span class="ruby-identifier">rounded_period</span>). 
        <span class="ruby-identifier">group</span>(<span class="ruby-string">&#39;g.id&#39;</span>).
        <span class="ruby-identifier">having</span>(<span class="ruby-string">&#39;qty &gt; 0&#39;</span>).
        <span class="ruby-identifier">order</span>(<span class="ruby-string">&#39;is_instant, parent_id, g.id&#39;</span>)
  <span class="ruby-identifier">sales_b</span> = <span class="ruby-identifier">sales</span>.      
        <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;s.date BETWEEN :from AND :to&quot;</span>, <span class="ruby-identifier">month_ago</span>(<span class="ruby-identifier">rounded_period</span>)).
        <span class="ruby-identifier">group</span>(<span class="ruby-string">&#39;g.id&#39;</span>).
        <span class="ruby-identifier">having</span>(<span class="ruby-string">&#39;qty &gt; 0&#39;</span>).
        <span class="ruby-identifier">order</span>(<span class="ruby-string">&#39;is_instant, parent_id, g.id&#39;</span>)
  <span class="ruby-identifier">sales_c</span> = <span class="ruby-identifier">sales</span>.      
        <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;s.date BETWEEN :from AND :to&quot;</span>, <span class="ruby-identifier">year_ago</span>(<span class="ruby-identifier">rounded_period</span>)).
        <span class="ruby-identifier">group</span>(<span class="ruby-string">&#39;g.id&#39;</span>).
        <span class="ruby-identifier">having</span>(<span class="ruby-string">&#39;qty &gt; 0&#39;</span>).
        <span class="ruby-identifier">order</span>(<span class="ruby-string">&#39;is_instant, parent_id, g.id&#39;</span>)

  <span class="ruby-identifier">sheet</span> = <span class="ruby-identifier">book</span>.<span class="ruby-identifier">create_worksheet</span> <span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;Споредба по 7 денa&#39;</span>

  <span class="ruby-comment"># worksheet default format</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">default_format</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>)

  <span class="ruby-comment"># Formating</span>
  <span class="ruby-identifier">font</span>      =  <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>) 
  <span class="ruby-identifier">font_sm</span>   =  <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>, <span class="ruby-identifier">size</span><span class="ruby-operator">:</span> <span class="ruby-value">8</span>) 
  <span class="ruby-identifier">bold_font_sm</span> =  <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>, <span class="ruby-identifier">size</span><span class="ruby-operator">:</span> <span class="ruby-value">8</span>, <span class="ruby-identifier">bold</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>) 
  <span class="ruby-identifier">bold_font</span> =  <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>, <span class="ruby-identifier">bold</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>) 
  <span class="ruby-identifier">line_fmt</span>  = [
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:left</span>,  <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,   <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,   <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#0.00%&#39;</span>,   <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font_sm</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#0.00%&#39;</span>,   <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font_sm</span>),
  ]
  <span class="ruby-identifier">lastln_fmt</span>  = [
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:left</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,
      <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,
      <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#0.00%&#39;</span>,
      <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font_sm</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#0.00%&#39;</span>,
      <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font_sm</span>),
  ]
  <span class="ruby-identifier">heading_fmt</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">weight</span><span class="ruby-operator">:</span> <span class="ruby-value">:bold</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, 
            <span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">text_wrap</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>, <span class="ruby-identifier">vertical_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:middle</span>, 
            <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>, <span class="ruby-identifier">bold</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>)
  <span class="ruby-identifier">heading_fmt</span>  = [
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">text_wrap</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>, <span class="ruby-identifier">vertical_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:middle</span>, <span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>,
        <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">bold_font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">text_wrap</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>, <span class="ruby-identifier">vertical_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:middle</span>, <span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>,
        <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:left</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">bold_font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">text_wrap</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>, <span class="ruby-identifier">vertical_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:middle</span>, <span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>,
        <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">bold_font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">text_wrap</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>, <span class="ruby-identifier">vertical_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:middle</span>, <span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>,
        <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">bold_font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">text_wrap</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>, <span class="ruby-identifier">vertical_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:middle</span>, <span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>,
        <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">bold_font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">text_wrap</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>, <span class="ruby-identifier">vertical_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:middle</span>, <span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>,
        <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">bold_font</span>),
  ]
  <span class="ruby-identifier">total_fmt</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,
                <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">bold_font</span>)
  <span class="ruby-identifier">totperc_fmt</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, 
                <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#0.00%&#39;</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">bold_font_sm</span>)
  <span class="ruby-identifier">title_fmt</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">weight</span><span class="ruby-operator">:</span> <span class="ruby-value">:bold</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, 
            <span class="ruby-identifier">text_wrap</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>, <span class="ruby-identifier">vertical_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:middle</span>, <span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, 
            <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>, <span class="ruby-identifier">bold</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>, <span class="ruby-identifier">size</span><span class="ruby-operator">:</span> <span class="ruby-value">12</span>)

  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">width</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">8</span>).<span class="ruby-identifier">width</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">13</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">20</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">width</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">7</span>).<span class="ruby-identifier">width</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">12</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">3</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">2</span>).<span class="ruby-identifier">width</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">9</span>).<span class="ruby-identifier">width</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">14</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">14</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">3</span>).<span class="ruby-identifier">width</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">10</span>).<span class="ruby-identifier">width</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">15</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">12</span>
  
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">height</span> = <span class="ruby-value">18</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">height</span> = <span class="ruby-value">24</span>

  <span class="ruby-comment"># table A</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">0</span>)[<span class="ruby-value">0</span>] = <span class="ruby-node">&quot;А: #{ rounded_period[:from].strftime YMD_FMT } --&quot;</span> <span class="ruby-operator">+</span>
                    <span class="ruby-node">&quot; #{ rounded_period[:to].strftime YMD_FMT }&quot;</span>
  <span class="ruby-value">0</span>.<span class="ruby-identifier">upto</span>(<span class="ruby-value">5</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">c</span>, <span class="ruby-identifier">title_fmt</span> }
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">merge_cells</span> <span class="ruby-value">0</span>, <span class="ruby-value">0</span>, <span class="ruby-value">0</span>, <span class="ruby-value">5</span>

  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">push</span> <span class="ruby-operator">*</span>[ <span class="ruby-string">&quot;id&quot;</span>, <span class="ruby-string">&quot;игра&quot;</span>, <span class="ruby-string">&quot;пари&quot;</span>, <span class="ruby-string">&quot;тикети / комб.&quot;</span>, <span class="ruby-string">&quot;А vs Б&quot;</span>, <span class="ruby-string">&quot;А vs В&quot;</span> ]
  <span class="ruby-value">0</span>.<span class="ruby-identifier">upto</span>(<span class="ruby-value">5</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">i</span>, <span class="ruby-identifier">heading_fmt</span>[<span class="ruby-identifier">i</span>] }

  <span class="ruby-identifier">ri</span> = <span class="ruby-value">2</span>
  <span class="ruby-identifier">sales_a</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">s</span>, <span class="ruby-identifier">idx</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">r</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span> <span class="ruby-identifier">ri</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-value">0</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">game_id</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-value">1</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">name</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-value">2</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">sales</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-value">3</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">qty</span>
    
    <span class="ruby-identifier">b</span> = <span class="ruby-identifier">sales_b</span>.<span class="ruby-identifier">select</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">game_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">game_id</span>}[<span class="ruby-value">0</span>]
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">b</span>
      <span class="ruby-identifier">r</span>[<span class="ruby-value">4</span>] = (<span class="ruby-identifier">s</span>.<span class="ruby-identifier">sales</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">b</span>.<span class="ruby-identifier">sales</span>)<span class="ruby-operator">/</span><span class="ruby-identifier">b</span>.<span class="ruby-identifier">sales</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">c</span> = <span class="ruby-identifier">sales_c</span>.<span class="ruby-identifier">select</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">game_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">game_id</span>}[<span class="ruby-value">0</span>]
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">c</span>
      <span class="ruby-identifier">r</span>[<span class="ruby-value">5</span>] = (<span class="ruby-identifier">s</span>.<span class="ruby-identifier">sales</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">c</span>.<span class="ruby-identifier">sales</span>)<span class="ruby-operator">/</span><span class="ruby-identifier">c</span>.<span class="ruby-identifier">sales</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">ln_fmt</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">idx</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">sales_a</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span> <span class="ruby-keyword">then</span> <span class="ruby-identifier">lastln_fmt</span> <span class="ruby-keyword">else</span> <span class="ruby-identifier">line_fmt</span> <span class="ruby-keyword">end</span>
    <span class="ruby-value">0</span>.<span class="ruby-identifier">upto</span>(<span class="ruby-value">5</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">i</span>, <span class="ruby-identifier">ln_fmt</span>[<span class="ruby-identifier">i</span>] }
    
    <span class="ruby-identifier">ri</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-comment"># totals A</span>
  <span class="ruby-identifier">compare_total_for</span> <span class="ruby-identifier">sheet</span>, <span class="ruby-identifier">sales_a</span>, <span class="ruby-identifier">ri</span>, <span class="ruby-value">1</span>
  <span class="ruby-identifier">row_a</span> = <span class="ruby-identifier">ri</span>
  
  <span class="ruby-comment"># table B</span>
  <span class="ruby-identifier">a_month_ago</span> = <span class="ruby-identifier">month_ago</span> <span class="ruby-identifier">rounded_period</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">0</span>)[<span class="ruby-value">7</span>] = <span class="ruby-node">&quot;Б: #{ a_month_ago[:from].strftime YMD_FMT } --&quot;</span> <span class="ruby-operator">+</span>
                    <span class="ruby-node">&quot; #{ a_month_ago[:to].strftime YMD_FMT }&quot;</span>
  <span class="ruby-value">7</span>.<span class="ruby-identifier">upto</span>(<span class="ruby-value">10</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">c</span>, <span class="ruby-identifier">title_fmt</span> }
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">merge_cells</span> <span class="ruby-value">0</span>, <span class="ruby-value">7</span>, <span class="ruby-value">0</span>, <span class="ruby-value">10</span>

  <span class="ruby-identifier">off</span> = <span class="ruby-value">7</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">1</span>)[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">0</span>] = <span class="ruby-string">&quot;id&quot;</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">1</span>)[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>] = <span class="ruby-string">&quot;игра&quot;</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">1</span>)[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>] = <span class="ruby-string">&quot;пари&quot;</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">1</span>)[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">3</span>] = <span class="ruby-string">&quot;тикети / комб.&quot;</span>
  <span class="ruby-value">0</span>.<span class="ruby-identifier">upto</span>(<span class="ruby-value">3</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">i</span>, <span class="ruby-identifier">heading_fmt</span>[<span class="ruby-identifier">i</span>] }

  <span class="ruby-identifier">ri</span> = <span class="ruby-value">2</span>
  <span class="ruby-identifier">sales_b</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">s</span>, <span class="ruby-identifier">idx</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">r</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span> <span class="ruby-identifier">ri</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">0</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">game_id</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">name</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">sales</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">3</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">qty</span>
    <span class="ruby-identifier">ln_fmt</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">idx</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">sales_b</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span> <span class="ruby-keyword">then</span> <span class="ruby-identifier">lastln_fmt</span> <span class="ruby-keyword">else</span> <span class="ruby-identifier">line_fmt</span> <span class="ruby-keyword">end</span>
    <span class="ruby-value">0</span>.<span class="ruby-identifier">upto</span>(<span class="ruby-value">3</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">i</span>, <span class="ruby-identifier">ln_fmt</span>[<span class="ruby-identifier">i</span>] }
    
    <span class="ruby-identifier">ri</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-comment"># totals B</span>
  <span class="ruby-identifier">compare_total_for</span> <span class="ruby-identifier">sheet</span>, <span class="ruby-identifier">sales_b</span>, <span class="ruby-identifier">ri</span>, <span class="ruby-value">8</span>
  <span class="ruby-identifier">row_b</span> = <span class="ruby-identifier">ri</span>

  <span class="ruby-comment"># table C</span>
  <span class="ruby-identifier">a_year_ago</span> = <span class="ruby-identifier">year_ago</span> <span class="ruby-identifier">rounded_period</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">0</span>)[<span class="ruby-value">12</span>] = <span class="ruby-node">&quot;В: #{ a_year_ago[:from].strftime YMD_FMT } --&quot;</span> <span class="ruby-operator">+</span>
                    <span class="ruby-node">&quot; #{ a_year_ago[:to].strftime YMD_FMT }&quot;</span>
  <span class="ruby-value">12</span>.<span class="ruby-identifier">upto</span>(<span class="ruby-value">15</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">c</span>, <span class="ruby-identifier">title_fmt</span> }
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">merge_cells</span> <span class="ruby-value">0</span>, <span class="ruby-value">12</span>, <span class="ruby-value">0</span>, <span class="ruby-value">15</span>
  <span class="ruby-identifier">off</span> = <span class="ruby-value">12</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">1</span>)[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">0</span>] = <span class="ruby-string">&quot;id&quot;</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">1</span>)[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>] = <span class="ruby-string">&quot;игра&quot;</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">1</span>)[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>] = <span class="ruby-string">&quot;пари&quot;</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">1</span>)[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">3</span>] = <span class="ruby-string">&quot;тикети / комб.&quot;</span>
  <span class="ruby-value">0</span>.<span class="ruby-identifier">upto</span>(<span class="ruby-value">3</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">i</span>, <span class="ruby-identifier">heading_fmt</span>[<span class="ruby-identifier">i</span>] }

  <span class="ruby-identifier">ri</span> = <span class="ruby-value">2</span>
  <span class="ruby-identifier">sales_c</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">s</span>, <span class="ruby-identifier">idx</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">r</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span> <span class="ruby-identifier">ri</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">0</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">game_id</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">name</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">sales</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">3</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">qty</span>
    <span class="ruby-identifier">ln_fmt</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">idx</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">sales_c</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span> <span class="ruby-keyword">then</span> <span class="ruby-identifier">lastln_fmt</span> <span class="ruby-keyword">else</span> <span class="ruby-identifier">line_fmt</span> <span class="ruby-keyword">end</span>
    <span class="ruby-value">0</span>.<span class="ruby-identifier">upto</span>(<span class="ruby-value">3</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">i</span>, <span class="ruby-identifier">ln_fmt</span>[<span class="ruby-identifier">i</span>] }
    
    <span class="ruby-identifier">ri</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-comment"># totals C</span>
  <span class="ruby-identifier">compare_total_for</span> <span class="ruby-identifier">sheet</span>, <span class="ruby-identifier">sales_c</span>, <span class="ruby-identifier">ri</span>, <span class="ruby-value">13</span>
  <span class="ruby-identifier">row_c</span> = <span class="ruby-identifier">ri</span>

  <span class="ruby-comment"># increase AvB, AvC</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_a</span>)[<span class="ruby-value">4</span>] = (<span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_a</span>)[<span class="ruby-value">2</span>] <span class="ruby-operator">-</span> <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_b</span>)[<span class="ruby-value">9</span>]) <span class="ruby-operator">/</span> <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_b</span>)[<span class="ruby-value">9</span>]
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_a</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>)[<span class="ruby-value">4</span>] = (<span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_a</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>)[<span class="ruby-value">2</span>] <span class="ruby-operator">-</span> <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_b</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>)[<span class="ruby-value">9</span>]) <span class="ruby-operator">/</span> 
                            <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_b</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>)[<span class="ruby-value">9</span>]
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_a</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>)[<span class="ruby-value">4</span>] = (<span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_a</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>)[<span class="ruby-value">2</span>] <span class="ruby-operator">-</span> <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_b</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>)[<span class="ruby-value">9</span>]) <span class="ruby-operator">/</span> 
                            <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_b</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>)[<span class="ruby-value">9</span>]
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_a</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-value">4</span>, <span class="ruby-identifier">totperc_fmt</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_a</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-value">4</span>, <span class="ruby-identifier">totperc_fmt</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_a</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-value">4</span>, <span class="ruby-identifier">totperc_fmt</span>

  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_a</span>)[<span class="ruby-value">5</span>] = (<span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_a</span>)[<span class="ruby-value">2</span>] <span class="ruby-operator">-</span> <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_c</span>)[<span class="ruby-value">14</span>]) <span class="ruby-operator">/</span> <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_c</span>)[<span class="ruby-value">14</span>]
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_a</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>)[<span class="ruby-value">5</span>] = (<span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_a</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>)[<span class="ruby-value">2</span>] <span class="ruby-operator">-</span> <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_c</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>)[<span class="ruby-value">14</span>]) <span class="ruby-operator">/</span> 
                            <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_c</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>)[<span class="ruby-value">14</span>]
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_a</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>)[<span class="ruby-value">5</span>] = (<span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_a</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>)[<span class="ruby-value">2</span>] <span class="ruby-operator">-</span> <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_c</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>)[<span class="ruby-value">14</span>]) <span class="ruby-operator">/</span> 
                            <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_c</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>)[<span class="ruby-value">14</span>]
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_a</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-value">5</span>, <span class="ruby-identifier">totperc_fmt</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_a</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-value">5</span>, <span class="ruby-identifier">totperc_fmt</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_a</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-value">5</span>, <span class="ruby-identifier">totperc_fmt</span>

<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-create_inactive_sheets" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">create_inactive_sheets</span><span
            class="method-args">(book, day)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Create sheets for inactive terminals  for instants games</p>
          
          

          
          <div class="method-source-code" id="create_inactive_sheets-source">
            <pre><span class="ruby-comment"># File lib/comp/utils.rb, line 1327</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">create_inactive_sheets</span> <span class="ruby-identifier">book</span>, <span class="ruby-identifier">day</span>
  <span class="ruby-identifier">instant_games</span> = <span class="ruby-constant">Sale</span>.<span class="ruby-identifier">select</span>(<span class="ruby-string">&#39;DISTINCT s.game_id AS game_id&#39;</span>).
                    <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;s.date BETWEEN date(:day, &#39;start of month&#39;) AND :day&quot;</span>, <span class="ruby-identifier">day</span><span class="ruby-operator">:</span> <span class="ruby-identifier">day</span>).
                    <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;g.type = &#39;INSTANT&#39;&quot;</span>).
                    <span class="ruby-identifier">where</span>(<span class="ruby-string">&#39;s.sales &lt;&gt; 0.0&#39;</span>). <span class="ruby-comment"># check if needed</span>
                    <span class="ruby-identifier">joins</span>(<span class="ruby-string">&#39;AS s INNER JOIN games AS g ON s.game_id = g.id&#39;</span>).
                    <span class="ruby-identifier">order</span>(<span class="ruby-string">&#39;s.game_id&#39;</span>)
  <span class="ruby-identifier">instant_ids</span> = <span class="ruby-identifier">instant_games</span>.<span class="ruby-identifier">to_a</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">game_id</span> }

  <span class="ruby-identifier">terminals_with_instants</span> = 
    <span class="ruby-constant">Sale</span>.<span class="ruby-identifier">select</span>(<span class="ruby-string">&#39;DISTINCT terminal_id&#39;</span>).
         <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;date BETWEEN date(:day, &#39;start of month&#39;) AND :day&quot;</span>, <span class="ruby-identifier">day</span><span class="ruby-operator">:</span> <span class="ruby-identifier">day</span>).
         <span class="ruby-identifier">where</span>(<span class="ruby-string">&#39;game_id IN (:instants)&#39;</span>, <span class="ruby-identifier">instants</span><span class="ruby-operator">:</span> <span class="ruby-identifier">instant_ids</span>).
         <span class="ruby-identifier">where</span>(<span class="ruby-string">&#39;sales IS NOT NULL AND sales &lt;&gt; 0.0&#39;</span>). <span class="ruby-comment"># here is needed</span>
         <span class="ruby-identifier">order</span>(<span class="ruby-string">&#39;terminal_id&#39;</span>) 
  <span class="ruby-identifier">terminal_ids</span> = <span class="ruby-identifier">terminals_with_instants</span>.<span class="ruby-identifier">to_a</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">terminal_id</span> }

  <span class="ruby-comment"># create the worksheet</span>
  <span class="ruby-identifier">summary</span>   = <span class="ruby-identifier">book</span>.<span class="ruby-identifier">create_worksheet</span> <span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;Инстанти - Неактивни терминали (сумарно)&#39;</span>
  <span class="ruby-identifier">detailed</span>  = <span class="ruby-identifier">book</span>.<span class="ruby-identifier">create_worksheet</span> <span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;Инстанти - Неактивни терминали (детално)&#39;</span>
  
  <span class="ruby-comment"># row indexes in each sheet</span>
  <span class="ruby-identifier">sidx</span> = <span class="ruby-value">0</span>
  <span class="ruby-identifier">didx</span> = <span class="ruby-value">0</span>
  
  <span class="ruby-comment"># insert titles in each sheet, heading and columns and rows widths and heights</span>
  <span class="ruby-identifier">title_fmt</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">weight</span><span class="ruby-operator">:</span> <span class="ruby-value">:bold</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, 
                <span class="ruby-identifier">text_wrap</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>, <span class="ruby-identifier">vertical_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:middle</span>, <span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">text_wrap</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>,
                <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>, <span class="ruby-identifier">bold</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>, <span class="ruby-identifier">size</span><span class="ruby-operator">:</span> <span class="ruby-value">12</span>)
  <span class="ruby-identifier">font</span>      =  <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>) 
  <span class="ruby-identifier">bold_font</span> =  <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>, <span class="ruby-identifier">bold</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>) 
  <span class="ruby-identifier">heading_fmt</span>  = [
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">text_wrap</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>, <span class="ruby-identifier">vertical_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:middle</span>, <span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>,
        <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">bold_font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">text_wrap</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>, <span class="ruby-identifier">vertical_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:middle</span>, <span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>,
        <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:left</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">bold_font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">text_wrap</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>, <span class="ruby-identifier">vertical_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:middle</span>, <span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>,
        <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">bold_font</span>),
  ]
  <span class="ruby-identifier">sline_fmt</span>  = [
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:left</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
  ]
  <span class="ruby-identifier">summary</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">3</span>
  <span class="ruby-identifier">summary</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">25</span>
  <span class="ruby-identifier">summary</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">2</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">16</span>
  <span class="ruby-identifier">summary</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">sidx</span>)[<span class="ruby-value">0</span>] = <span class="ruby-string">&quot;Терминали кои не примаат одреден инстант (сумарно)&quot;</span>
  (<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">2</span>).<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">summary</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">sidx</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">c</span>, <span class="ruby-identifier">title_fmt</span> }
  <span class="ruby-identifier">summary</span>.<span class="ruby-identifier">merge_cells</span> <span class="ruby-identifier">sidx</span>, <span class="ruby-value">0</span>, <span class="ruby-identifier">sidx</span>, <span class="ruby-value">2</span>
  <span class="ruby-identifier">summary</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">sidx</span>).<span class="ruby-identifier">height</span> = <span class="ruby-value">32</span>
  <span class="ruby-identifier">sidx</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
  <span class="ruby-identifier">summary</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">sidx</span>).<span class="ruby-identifier">push</span> <span class="ruby-string">&#39;id&#39;</span>, <span class="ruby-string">&#39;инстант&#39;</span>, <span class="ruby-string">&quot;бр. неактивни\nтерминали&quot;</span>
  (<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">2</span>).<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">summary</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">sidx</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">c</span>, <span class="ruby-identifier">heading_fmt</span>[<span class="ruby-identifier">c</span>] }
  <span class="ruby-identifier">summary</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">sidx</span>).<span class="ruby-identifier">height</span> = <span class="ruby-value">26</span>
  <span class="ruby-identifier">sidx</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
  
  <span class="ruby-identifier">detailed</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">default_format</span> = 
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>)
  <span class="ruby-identifier">detailed</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">default_format</span> = 
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:left</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>)
  <span class="ruby-identifier">detailed</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">8</span>
  <span class="ruby-identifier">detailed</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">75</span>
  <span class="ruby-identifier">detailed</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">didx</span>)[<span class="ruby-value">0</span>] = <span class="ruby-string">&quot;Терминали кои не примаат одреден инстант \n(детално)&quot;</span>
  (<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">1</span>).<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">detailed</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">didx</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">c</span>, <span class="ruby-identifier">title_fmt</span> }
  <span class="ruby-identifier">detailed</span>.<span class="ruby-identifier">merge_cells</span> <span class="ruby-identifier">didx</span>, <span class="ruby-value">0</span>, <span class="ruby-identifier">didx</span>, <span class="ruby-value">1</span>
  <span class="ruby-identifier">detailed</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">didx</span>).<span class="ruby-identifier">height</span> = <span class="ruby-value">32</span>
  <span class="ruby-identifier">didx</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>

  <span class="ruby-comment"># loop per instant</span>
  <span class="ruby-identifier">instant_ids</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">id</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">inactive_ids</span> = 
      <span class="ruby-identifier">terminal_ids</span> <span class="ruby-operator">-</span> 
      <span class="ruby-constant">Terminal</span>.<span class="ruby-identifier">select</span>(<span class="ruby-string">&#39;t.id AS terminal_id, t.name AS name, SUM(s.sales) AS total&#39;</span>).
        <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;s.date BETWEEN date(:day, &#39;start of month&#39;) AND :day&quot;</span>, <span class="ruby-identifier">day</span><span class="ruby-operator">:</span> <span class="ruby-identifier">day</span>).
        <span class="ruby-identifier">where</span>(<span class="ruby-string">&#39;s.game_id = :game_id&#39;</span>, <span class="ruby-identifier">game_id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">id</span>).
        <span class="ruby-identifier">joins</span>(<span class="ruby-string">&#39;AS t INNER JOIN sales AS s ON t.id = s.terminal_id&#39;</span>).
        <span class="ruby-identifier">group</span>(<span class="ruby-string">&#39;t.id&#39;</span>).
        <span class="ruby-identifier">having</span>(<span class="ruby-string">&#39;total &gt; 0.0&#39;</span>).
        <span class="ruby-identifier">order</span>(<span class="ruby-string">&#39;t.id&#39;</span>).<span class="ruby-identifier">to_a</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">terminal_id</span> }

    <span class="ruby-comment"># summary sheet</span>
    <span class="ruby-identifier">summary</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">sidx</span>).<span class="ruby-identifier">push</span> <span class="ruby-operator">*</span>[ <span class="ruby-identifier">id</span>, <span class="ruby-constant">Game</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">id</span>).<span class="ruby-identifier">name</span>, <span class="ruby-identifier">inactive_ids</span>.<span class="ruby-identifier">count</span> ]
    (<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">2</span>).<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">summary</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">sidx</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">c</span>, <span class="ruby-identifier">sline_fmt</span>[<span class="ruby-identifier">c</span>] }
    <span class="ruby-identifier">sidx</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
    
    <span class="ruby-comment"># detailed sheet</span>
    <span class="ruby-identifier">detailed</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">didx</span>)[<span class="ruby-value">0</span>] = <span class="ruby-constant">Game</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">id</span>).<span class="ruby-identifier">name</span>
    <span class="ruby-identifier">detailed</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">didx</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-value">0</span>, 
      <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">bold_font</span>)
    <span class="ruby-identifier">detailed</span>.<span class="ruby-identifier">merge_cells</span> <span class="ruby-identifier">didx</span>, <span class="ruby-value">0</span>, <span class="ruby-identifier">didx</span>, <span class="ruby-value">1</span>
    <span class="ruby-identifier">didx</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
    <span class="ruby-identifier">inactive_ids</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">id</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">detailed</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">didx</span>).<span class="ruby-identifier">push</span> <span class="ruby-identifier">id</span>, <span class="ruby-constant">Terminal</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">id</span>).<span class="ruby-identifier">name</span>
      <span class="ruby-identifier">didx</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-create_monthly_sheet" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">create_monthly_sheet</span><span
            class="method-args">(book, day)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>monthly sales</p>
          
          

          
          <div class="method-source-code" id="create_monthly_sheet-source">
            <pre><span class="ruby-comment"># File lib/comp/utils.rb, line 1216</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">create_monthly_sheet</span> <span class="ruby-identifier">book</span>, <span class="ruby-identifier">day</span>
  <span class="ruby-comment"># IMPORTANT:</span>
  <span class="ruby-comment"># shuld limit dates up to full month!</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">day</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">last_day_of_month</span>(<span class="ruby-identifier">day</span>)
    <span class="ruby-identifier">day</span> = (<span class="ruby-constant">Date</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">day</span>.<span class="ruby-identifier">year</span>, <span class="ruby-identifier">day</span>.<span class="ruby-identifier">month</span>, <span class="ruby-value">1</span>) <span class="ruby-operator">-</span> <span class="ruby-value">1</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">qry</span> =<span class="ruby-value">&lt;&lt;-EOT
    date(s.date, &#39;start of month&#39;)  AS fdom,
    SUM(s.sales)                    AS sales,
    COUNT(DISTINCT t.id)            AS term_count
  EOT</span>
  <span class="ruby-identifier">sales</span> = <span class="ruby-constant">Sale</span>.<span class="ruby-identifier">select</span>(<span class="ruby-identifier">qry</span>).
        <span class="ruby-identifier">joins</span>(<span class="ruby-string">&#39;AS s INNER JOIN terminals AS t ON s.terminal_id = t.id&#39;</span>).
        <span class="ruby-identifier">where</span>(<span class="ruby-string">&#39;s.date &lt;= :day&#39;</span>, <span class="ruby-identifier">day</span><span class="ruby-operator">:</span> <span class="ruby-identifier">day</span>).
        <span class="ruby-identifier">group</span>(<span class="ruby-string">&#39;fdom&#39;</span>).
        <span class="ruby-identifier">order</span>(<span class="ruby-string">&#39;fdom&#39;</span>)

  <span class="ruby-identifier">sheet</span> = <span class="ruby-identifier">book</span>.<span class="ruby-identifier">create_worksheet</span> <span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;Месечно&#39;</span>

  <span class="ruby-comment"># worksheet default format</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">default_format</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>)

  <span class="ruby-comment"># fix some column widths</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">12</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">2</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">14</span>

  <span class="ruby-comment"># heading format</span>
  <span class="ruby-identifier">heading_fmt</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, 
                <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>, <span class="ruby-identifier">bold</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>)
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">push</span> <span class="ruby-operator">*</span>[ <span class="ruby-string">&quot;месец &#39;год.&quot;</span>, <span class="ruby-string">&quot;бр. терм.&quot;</span>, <span class="ruby-string">&quot;уплата&quot;</span>, ]
  [<span class="ruby-value">0</span>, <span class="ruby-value">1</span>, <span class="ruby-value">2</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">c</span>, <span class="ruby-identifier">heading_fmt</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">sales</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">s</span>, <span class="ruby-identifier">idx</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">r</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">2</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">idx</span>)
    <span class="ruby-identifier">r</span>[<span class="ruby-value">0</span>] = <span class="ruby-constant">Date</span>.<span class="ruby-identifier">parse</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">fdom</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-value">1</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">term_count</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-value">2</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">sales</span>

    <span class="ruby-identifier">r</span>.<span class="ruby-identifier">set_format</span> <span class="ruby-value">0</span>, <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;MMM &#39;YY&quot;</span>, <span class="ruby-identifier">align</span><span class="ruby-operator">:</span> <span class="ruby-value">:left</span>,
              <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>))
    <span class="ruby-identifier">r</span>.<span class="ruby-identifier">set_format</span> <span class="ruby-value">1</span>, <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,
              <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>))
    <span class="ruby-identifier">r</span>.<span class="ruby-identifier">set_format</span> <span class="ruby-value">2</span>, <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,
              <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>))
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># table for the pivot table: monthly sales per game type</span>
  <span class="ruby-identifier">qry</span> =<span class="ruby-value">&lt;&lt;-EOT
    SELECT
      s.fdom        AS month,
      s.game_type   AS type,
      SUM(s.sales)  AS sales,
      SUM(s.qty)    AS qty
    FROM (
      SELECT
        date(s.date, &#39;start of month&#39;)
                      AS fdom,
        g.id          AS game_id,
        g.name        AS game_name,
        CASE 
          WHEN g.parent IS NOT NULL THEN g.parent
          ELSE g.id
        END           AS parent_id,
        g2.type       AS game_type,
        s.sales       AS sales,
        s.sales/g.price
                      AS  qty
      FROM
        games AS g
        INNER JOIN games AS g2
          ON g2.id = parent_id
        INNER JOIN sales AS s
          ON g.id = s.game_id
      WHERE sales &lt;&gt; 0.0
    ) AS s
    GROUP BY s.fdom, s.game_type
    ORDER BY s.fdom, s.game_type
  EOT</span>

  <span class="ruby-identifier">sales_by_type</span> = <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span> <span class="ruby-identifier">qry</span>
  <span class="ruby-identifier">sheet</span> = <span class="ruby-identifier">book</span>.<span class="ruby-identifier">create_worksheet</span> <span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;monthly-by-type&#39;</span>
  
  <span class="ruby-comment"># worksheet default format</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">default_format</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>)

  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">default_format</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;MMM &#39;YY&quot;</span>, <span class="ruby-identifier">align</span><span class="ruby-operator">:</span> <span class="ruby-value">:left</span>,
                  <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>))
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">default_format</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">align</span><span class="ruby-operator">:</span> <span class="ruby-value">:left</span>, 
                  <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>))
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">2</span>).<span class="ruby-identifier">default_format</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-node">&quot;#,###&quot;</span>, <span class="ruby-identifier">align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>,
                  <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>))
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">3</span>).<span class="ruby-identifier">default_format</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-node">&quot;#,###&quot;</span>, <span class="ruby-identifier">align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>,
                  <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>))
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">push</span> <span class="ruby-operator">*</span>[<span class="ruby-string">&#39;month&#39;</span>, <span class="ruby-string">&#39;type&#39;</span>, <span class="ruby-string">&#39;sales&#39;</span>, <span class="ruby-string">&#39;qty&#39;</span>] 
  <span class="ruby-identifier">sales_by_type</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">s</span>, <span class="ruby-identifier">idx</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">r</span>    = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span> <span class="ruby-identifier">idx</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-value">0</span>] = <span class="ruby-constant">Date</span>.<span class="ruby-identifier">parse</span> <span class="ruby-identifier">s</span>[<span class="ruby-string">&#39;month&#39;</span>]
    <span class="ruby-identifier">r</span>[<span class="ruby-value">1</span>] = <span class="ruby-constant">GAME_TYPES_MK</span>[<span class="ruby-identifier">s</span>[<span class="ruby-string">&#39;type&#39;</span>]]
    <span class="ruby-identifier">r</span>[<span class="ruby-value">2</span>] = <span class="ruby-identifier">s</span>[<span class="ruby-string">&#39;sales&#39;</span>].<span class="ruby-identifier">to_i</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-value">3</span>] = <span class="ruby-identifier">s</span>[<span class="ruby-string">&#39;qty&#39;</span>].<span class="ruby-identifier">to_i</span>
  <span class="ruby-keyword">end</span>

<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-create_remainder_sheet" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">create_remainder_sheet</span><span
            class="method-args">(book, day)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Remainder sheet</p>
          
          

          
          <div class="method-source-code" id="create_remainder_sheet-source">
            <pre><span class="ruby-comment"># File lib/comp/utils.rb, line 596</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">create_remainder_sheet</span> <span class="ruby-identifier">book</span>, <span class="ruby-identifier">day</span>

  <span class="ruby-identifier">funds_file</span>      = <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span> <span class="ruby-string">&#39;../../../config/funds.yml&#39;</span>, <span class="ruby-keyword">__FILE__</span>
  <span class="ruby-identifier">commission_file</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span> <span class="ruby-string">&#39;../../../config/commission.yml&#39;</span>, <span class="ruby-keyword">__FILE__</span>

  <span class="ruby-identifier">funds</span>       = <span class="ruby-constant">YAML</span><span class="ruby-operator">::</span><span class="ruby-identifier">load</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span> <span class="ruby-identifier">funds_file</span>
  <span class="ruby-identifier">commission</span>  = <span class="ruby-constant">YAML</span><span class="ruby-operator">::</span><span class="ruby-identifier">load</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span> <span class="ruby-identifier">commission_file</span>

  <span class="ruby-comment"># Formating</span>
  <span class="ruby-identifier">font</span>      =  <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>) 
  <span class="ruby-identifier">font_sm</span>   =  <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>, <span class="ruby-identifier">size</span><span class="ruby-operator">:</span> <span class="ruby-value">8</span>) 
  <span class="ruby-identifier">bold_font_sm</span> =  <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>, <span class="ruby-identifier">size</span><span class="ruby-operator">:</span> <span class="ruby-value">8</span>, <span class="ruby-identifier">bold</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>) 
  <span class="ruby-identifier">bold_font</span> =  <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>, <span class="ruby-identifier">bold</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>) 
  <span class="ruby-identifier">line_i_fmt</span>  = [
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:left</span>,  <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,   <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,   <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#0.00%&#39;</span>,  <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font_sm</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#0.00%&#39;</span>,  <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font_sm</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,   <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,   <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,   <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,   <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
  ]
  <span class="ruby-identifier">lastln_i_fmt</span>  = [
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:left</span>,  <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,
        <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,
        <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#0.00%&#39;</span>,
        <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font_sm</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#0.00%&#39;</span>,
        <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font_sm</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,
        <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,
        <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,
        <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,
        <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
  ]
  <span class="ruby-identifier">line_d_fmt</span>  = [
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:left</span>,  <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,  <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,  <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font_sm</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#0.00%&#39;</span>,  <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font_sm</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,   <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,   <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,   <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,   <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
  ]
  <span class="ruby-identifier">lastln_d_fmt</span>  = [
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:left</span>,  <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,
        <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,
        <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font_sm</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#0.00%&#39;</span>,
        <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font_sm</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,
        <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,
        <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,
        <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,
        <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
  ]
  <span class="ruby-identifier">total_fmt</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,
                <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">bold_font</span>)
  <span class="ruby-identifier">totperc_fmt</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, 
                <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#0.00%&#39;</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">bold_font_sm</span>)
  <span class="ruby-identifier">title_fmt</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">weight</span><span class="ruby-operator">:</span> <span class="ruby-value">:bold</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, 
            <span class="ruby-identifier">text_wrap</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>, <span class="ruby-identifier">vertical_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:middle</span>, <span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>,
            <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>, <span class="ruby-identifier">bold</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>, <span class="ruby-identifier">size</span><span class="ruby-operator">:</span> <span class="ruby-value">12</span>)

  <span class="ruby-identifier">sheet</span> = <span class="ruby-identifier">book</span>.<span class="ruby-identifier">create_worksheet</span> <span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;Остаток&#39;</span>

  <span class="ruby-comment"># worksheet default format</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">default_format</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>)

  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">width</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">11</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">3</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">width</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">12</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">20</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">2</span>).<span class="ruby-identifier">width</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">13</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">6</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">3</span>).<span class="ruby-identifier">width</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">14</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">6</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">5</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">6</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">6</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">12</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">8</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">12</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">9</span>).<span class="ruby-identifier">width</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">19</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">11</span>


  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">height</span> = <span class="ruby-value">20</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">height</span> = <span class="ruby-value">34</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">push</span> <span class="ruby-operator">*</span>[ <span class="ruby-string">&quot;id&quot;</span>, <span class="ruby-string">&quot;игра&quot;</span>, <span class="ruby-string">&quot;цена&quot;</span>, <span class="ruby-string">&quot;терм.&quot;</span>, <span class="ruby-string">&quot;фонд за доб.&quot;</span>, <span class="ruby-string">&quot;пров.&quot;</span>, <span class="ruby-string">&quot;уплата&quot;</span>,
                      <span class="ruby-string">&quot;тикети / комб.&quot;</span>, <span class="ruby-string">&quot;фонд + пров. + МПМ + РМ&quot;</span>, <span class="ruby-string">&quot;остаток&quot;</span>, <span class="ruby-string">&quot;&quot;</span>,
                      <span class="ruby-string">&quot;id&quot;</span>, <span class="ruby-string">&quot;игра&quot;</span>, <span class="ruby-string">&quot;цена&quot;</span>, <span class="ruby-string">&quot;терм.&quot;</span>, <span class="ruby-string">&quot;фонд за доб.&quot;</span>, <span class="ruby-string">&quot;уплата&quot;</span>,
                      <span class="ruby-string">&quot;тикети / комб.&quot;</span>, <span class="ruby-string">&quot;фонд + РМ&quot;</span>, <span class="ruby-string">&quot;остаток&quot;</span>,
                     ]
  <span class="ruby-identifier">heading_fmt</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">weight</span><span class="ruby-operator">:</span> <span class="ruby-value">:bold</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, 
            <span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">text_wrap</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>, <span class="ruby-identifier">vertical_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:middle</span>, 
            <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>, <span class="ruby-identifier">bold</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>)
  <span class="ruby-value">0</span>.<span class="ruby-identifier">upto</span>(<span class="ruby-value">9</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">i</span>, <span class="ruby-identifier">heading_fmt</span> }
  <span class="ruby-value">0</span>.<span class="ruby-identifier">upto</span>(<span class="ruby-value">8</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-value">11</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">i</span>, <span class="ruby-identifier">heading_fmt</span> }

  <span class="ruby-identifier">qry</span> =<span class="ruby-value">&lt;&lt;-EOT
    g.id                    AS game_id,
    g.name                  AS name,
    g.price                 AS price,
    CASE 
      WHEN g.type = &#39;INSTANT&#39; THEN 1
      ELSE 0
    END                     AS is_instant,
    CASE
      WHEN g.parent IS NOT NULL THEN g.parent
      ELSE g.id
    END                     AS parent_id,
    SUM(s.sales)            AS sales,
    SUM(s.sales) / g.price  AS qty,
    COUNT(DISTINCT t.id)    AS term_count
  EOT</span>

  <span class="ruby-identifier">sales</span> = <span class="ruby-constant">Sale</span>.<span class="ruby-identifier">select</span>(<span class="ruby-identifier">qry</span>).
        <span class="ruby-identifier">joins</span>(<span class="ruby-string">&#39;AS s INNER JOIN games AS g ON s.game_id = g.id&#39;</span>).
        <span class="ruby-identifier">joins</span>(<span class="ruby-string">&#39;INNER JOIN terminals AS t ON s.terminal_id = t.id&#39;</span>)
  <span class="ruby-identifier">sales_i</span> = <span class="ruby-identifier">sales</span>.      
        <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;s.date BETWEEN date(:day, &#39;start of month&#39;) AND :day&quot;</span>, <span class="ruby-identifier">day</span><span class="ruby-operator">:</span> <span class="ruby-identifier">day</span>). 
        <span class="ruby-identifier">where</span>(<span class="ruby-string">&#39;t.agent_id &lt;&gt; 225&#39;</span>).
        <span class="ruby-identifier">group</span>(<span class="ruby-string">&#39;g.id&#39;</span>).
        <span class="ruby-identifier">having</span>(<span class="ruby-string">&#39;qty &gt; 0&#39;</span>).
        <span class="ruby-identifier">order</span>(<span class="ruby-string">&#39;is_instant, parent_id, g.id&#39;</span>)
  <span class="ruby-identifier">sales_d</span> = <span class="ruby-identifier">sales</span>.      
        <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;s.date BETWEEN date(:day, &#39;start of month&#39;) AND :day&quot;</span>, <span class="ruby-identifier">day</span><span class="ruby-operator">:</span> <span class="ruby-identifier">day</span>). 
        <span class="ruby-identifier">where</span>(<span class="ruby-string">&#39;t.agent_id = 225&#39;</span>).
        <span class="ruby-identifier">group</span>(<span class="ruby-string">&#39;g.id&#39;</span>).
        <span class="ruby-identifier">having</span>(<span class="ruby-string">&#39;qty &gt; 0&#39;</span>).
        <span class="ruby-identifier">order</span>(<span class="ruby-string">&#39;is_instant, parent_id, g.id&#39;</span>)

  <span class="ruby-comment"># indirect</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">0</span>)[<span class="ruby-value">0</span>] = <span class="ruby-node">&quot;Индиректна продажба, #{ MONTH_NAMES_MK[day.month] } #{ day.year }&quot;</span>
  <span class="ruby-value">0</span>.<span class="ruby-identifier">upto</span>(<span class="ruby-value">9</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">c</span>, <span class="ruby-identifier">title_fmt</span> }
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">merge_cells</span> <span class="ruby-value">0</span>, <span class="ruby-value">0</span>, <span class="ruby-value">0</span>, <span class="ruby-value">9</span>
  <span class="ruby-identifier">r8_tot</span> = <span class="ruby-value">0</span>
  <span class="ruby-identifier">r9_tot</span> = <span class="ruby-value">0</span>
  <span class="ruby-identifier">sales_i</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">s</span>, <span class="ruby-identifier">idx</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">r</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span> <span class="ruby-value">2</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">idx</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-value">0</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">game_id</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-value">1</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">name</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-value">2</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">price</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-value">3</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">term_count</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Undefined funds for #{ s.game_id }&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">funds</span>[<span class="ruby-identifier">s</span>.<span class="ruby-identifier">game_id</span>.<span class="ruby-identifier">to_s</span>]
    <span class="ruby-identifier">r</span>[<span class="ruby-value">4</span>] = <span class="ruby-identifier">funds</span>[<span class="ruby-identifier">s</span>.<span class="ruby-identifier">game_id</span>.<span class="ruby-identifier">to_s</span>]
    <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Undefined commission for #{ s.game_id }&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">commission</span>[<span class="ruby-identifier">s</span>.<span class="ruby-identifier">game_id</span>.<span class="ruby-identifier">to_s</span>]
    <span class="ruby-identifier">r</span>[<span class="ruby-value">5</span>] = <span class="ruby-identifier">commission</span>[<span class="ruby-identifier">s</span>.<span class="ruby-identifier">game_id</span>.<span class="ruby-identifier">to_s</span>]
    <span class="ruby-identifier">r</span>[<span class="ruby-value">6</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">sales</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-value">7</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">qty</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-value">8</span>] = (<span class="ruby-identifier">r</span>[<span class="ruby-value">4</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">r</span>[<span class="ruby-value">5</span>] <span class="ruby-operator">+</span> <span class="ruby-constant">RM_PERC</span> <span class="ruby-operator">+</span> <span class="ruby-constant">MPM_PERC</span>) <span class="ruby-operator">*</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">sales</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-value">9</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">sales</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">r</span>[<span class="ruby-value">8</span>]

    <span class="ruby-comment"># update totals</span>
    <span class="ruby-identifier">r8_tot</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">r</span>[<span class="ruby-value">8</span>]
    <span class="ruby-identifier">r9_tot</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">r</span>[<span class="ruby-value">9</span>]

    <span class="ruby-identifier">ln_fmt</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">idx</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">sales_i</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span> <span class="ruby-keyword">then</span> <span class="ruby-identifier">lastln_i_fmt</span> <span class="ruby-keyword">else</span> <span class="ruby-identifier">line_i_fmt</span> <span class="ruby-keyword">end</span>
    <span class="ruby-value">0</span>.<span class="ruby-identifier">upto</span>(<span class="ruby-value">9</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">i</span>, <span class="ruby-identifier">ln_fmt</span>[<span class="ruby-identifier">i</span>] }
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">row</span> = <span class="ruby-identifier">sales_i</span>.<span class="ruby-identifier">length</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>)[<span class="ruby-value">6</span>] = <span class="ruby-identifier">sales_i</span>.<span class="ruby-identifier">inject</span>(<span class="ruby-value">0</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">sum</span>, <span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sum</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">sales</span> }
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-value">6</span>, <span class="ruby-identifier">total_fmt</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>)[<span class="ruby-value">8</span>] = <span class="ruby-identifier">r8_tot</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-value">8</span>, <span class="ruby-identifier">total_fmt</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>)[<span class="ruby-value">9</span>] = <span class="ruby-identifier">r9_tot</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-value">9</span>, <span class="ruby-identifier">total_fmt</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row</span> <span class="ruby-operator">+</span> <span class="ruby-value">3</span>)[<span class="ruby-value">9</span>] = <span class="ruby-identifier">r9_tot</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>)[<span class="ruby-value">6</span>]
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row</span> <span class="ruby-operator">+</span> <span class="ruby-value">3</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-value">9</span>, <span class="ruby-identifier">totperc_fmt</span>

  <span class="ruby-comment"># direct</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">0</span>)[<span class="ruby-value">11</span>] = <span class="ruby-node">&quot;Директна продажба, #{ MONTH_NAMES_MK[day.month] } #{ day.year }&quot;</span>
  <span class="ruby-value">11</span>.<span class="ruby-identifier">upto</span>(<span class="ruby-value">19</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-value">11</span>, <span class="ruby-identifier">title_fmt</span> }
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">merge_cells</span> <span class="ruby-value">0</span>, <span class="ruby-value">11</span>, <span class="ruby-value">0</span>, <span class="ruby-value">19</span>
  <span class="ruby-identifier">r7_tot</span>  = <span class="ruby-value">0</span>
  <span class="ruby-identifier">r8_tot</span>  = <span class="ruby-value">0</span>
  <span class="ruby-identifier">off</span>     = <span class="ruby-value">11</span>
  <span class="ruby-identifier">sales_d</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">s</span>, <span class="ruby-identifier">idx</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">r</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span> <span class="ruby-value">2</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">idx</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">0</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">game_id</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">name</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">price</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">3</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">term_count</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Undefined funds for #{ s.game_id }&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">funds</span>[<span class="ruby-identifier">s</span>.<span class="ruby-identifier">game_id</span>.<span class="ruby-identifier">to_s</span>]
    <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">4</span>] = <span class="ruby-identifier">funds</span>[<span class="ruby-identifier">s</span>.<span class="ruby-identifier">game_id</span>.<span class="ruby-identifier">to_s</span>]
    <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">5</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">sales</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">6</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">qty</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">7</span>] = (<span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">4</span>] <span class="ruby-operator">+</span> <span class="ruby-constant">RM_PERC</span>) <span class="ruby-operator">*</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">sales</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">8</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">sales</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">7</span>]

    <span class="ruby-comment"># update totals</span>
    <span class="ruby-identifier">r7_tot</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">7</span>]
    <span class="ruby-identifier">r8_tot</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">8</span>]

    <span class="ruby-identifier">ln_fmt</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">idx</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">sales_d</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span> <span class="ruby-keyword">then</span> <span class="ruby-identifier">lastln_d_fmt</span> <span class="ruby-keyword">else</span> <span class="ruby-identifier">line_d_fmt</span> <span class="ruby-keyword">end</span>
    <span class="ruby-value">0</span>.<span class="ruby-identifier">upto</span>(<span class="ruby-value">8</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">i</span>, <span class="ruby-identifier">ln_fmt</span>[<span class="ruby-identifier">i</span>] }
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">row</span> = <span class="ruby-identifier">sales_d</span>.<span class="ruby-identifier">length</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>)[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">5</span>] = <span class="ruby-identifier">sales_d</span>.<span class="ruby-identifier">inject</span>(<span class="ruby-value">0</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">sum</span>, <span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sum</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">sales</span> }
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">5</span>, <span class="ruby-identifier">total_fmt</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>)[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">7</span>] = <span class="ruby-identifier">r7_tot</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">7</span>, <span class="ruby-identifier">total_fmt</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>)[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">8</span>] = <span class="ruby-identifier">r8_tot</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">8</span>, <span class="ruby-identifier">total_fmt</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row</span> <span class="ruby-operator">+</span> <span class="ruby-value">3</span>)[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">8</span>] = <span class="ruby-identifier">r8_tot</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>)[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">5</span>]
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row</span> <span class="ruby-operator">+</span> <span class="ruby-value">3</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">8</span>, <span class="ruby-identifier">totperc_fmt</span>

  <span class="ruby-comment">#</span>
  <span class="ruby-comment"># google chart indirect</span>
  <span class="ruby-comment">#</span>

  <span class="ruby-comment"># chart colors</span>
  <span class="ruby-identifier">cat10_colors</span> = <span class="ruby-node">%W{ 1f77b4 ff7f0e 2ca02c d62728 9467bd 8c564b e377c2 7f7f7f bcbd22 17becf }</span> 

  <span class="ruby-comment"># inderect</span>
  <span class="ruby-identifier">arr_i</span> = [ <span class="ruby-comment"># funds, commission, MPM, RM</span>
    <span class="ruby-identifier">sales_i</span>.<span class="ruby-identifier">inject</span>(<span class="ruby-value">0</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">sum</span>, <span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sum</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">sales</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">funds</span>[<span class="ruby-identifier">s</span>.<span class="ruby-identifier">game_id</span>.<span class="ruby-identifier">to_s</span>] },
    <span class="ruby-identifier">sales_i</span>.<span class="ruby-identifier">inject</span>(<span class="ruby-value">0</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">sum</span>, <span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sum</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">sales</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">commission</span>[<span class="ruby-identifier">s</span>.<span class="ruby-identifier">game_id</span>.<span class="ruby-identifier">to_s</span>] },
    <span class="ruby-identifier">sales_i</span>.<span class="ruby-identifier">inject</span>(<span class="ruby-value">0</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">sum</span>, <span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sum</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">sales</span> <span class="ruby-operator">*</span> <span class="ruby-constant">MPM_PERC</span> },
    <span class="ruby-identifier">sales_i</span>.<span class="ruby-identifier">inject</span>(<span class="ruby-value">0</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">sum</span>, <span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sum</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">sales</span> <span class="ruby-operator">*</span> <span class="ruby-constant">RM_PERC</span> },
  ]
  <span class="ruby-identifier">arr_i</span> <span class="ruby-operator">&lt;&lt;</span> (<span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">sales_i</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>)[<span class="ruby-value">6</span>] <span class="ruby-operator">-</span> <span class="ruby-identifier">arr_i</span>.<span class="ruby-identifier">inject</span>(<span class="ruby-value">0</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">sum</span>, <span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sum</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">s</span> })
  <span class="ruby-identifier">tot_i</span> = <span class="ruby-identifier">arr_i</span>.<span class="ruby-identifier">inject</span>(<span class="ruby-value">0</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">sum</span>, <span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sum</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">s</span> }
  <span class="ruby-identifier">p</span> = <span class="ruby-identifier">sprintf</span> <span class="ruby-string">&quot;%5.2f%%|%5.2f%%|%5.2f%%|%5.2f%%|%5.2f%%&quot;</span>, <span class="ruby-identifier">arr_i</span>[<span class="ruby-value">0</span>]<span class="ruby-operator">/</span><span class="ruby-identifier">tot_i</span><span class="ruby-operator">*</span><span class="ruby-value">100</span>,
              <span class="ruby-identifier">arr_i</span>[<span class="ruby-value">1</span>]<span class="ruby-operator">/</span><span class="ruby-identifier">tot_i</span><span class="ruby-operator">*</span><span class="ruby-value">100</span>,
              <span class="ruby-identifier">arr_i</span>[<span class="ruby-value">2</span>]<span class="ruby-operator">/</span><span class="ruby-identifier">tot_i</span><span class="ruby-operator">*</span><span class="ruby-value">100</span>,
              <span class="ruby-identifier">arr_i</span>[<span class="ruby-value">3</span>]<span class="ruby-operator">/</span><span class="ruby-identifier">tot_i</span><span class="ruby-operator">*</span><span class="ruby-value">100</span>,
              <span class="ruby-identifier">arr_i</span>[<span class="ruby-value">4</span>]<span class="ruby-operator">/</span><span class="ruby-identifier">tot_i</span><span class="ruby-operator">*</span><span class="ruby-value">100</span> <span class="ruby-comment"># remainder</span>
  <span class="ruby-identifier">s</span> = <span class="ruby-string">&quot;https://chart.googleapis.com/chart&quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-string">&quot;?chs=720x400&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-comment"># chart size</span>
      <span class="ruby-string">&quot;&amp;chma=10,50,40,10&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-comment"># chart margins</span>
      <span class="ruby-string">&quot;&amp;cht=p&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-comment"># 2d pie chart</span>
      <span class="ruby-node">&quot;&amp;chco=#{ cat10_colors[0..3].join &#39;,&#39; }&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-comment"># series color</span>
      <span class="ruby-node">&quot;&amp;chd=t:#{ arr_i.map {|x| x.to_i}.join &#39;,&#39; }&quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-string">&quot;&amp;chds=a&quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-string">&quot;&amp;chxt=x&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-comment"># axis labels</span>
      <span class="ruby-string">&quot;&amp;chxs=0,000000,14&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-comment"># axis label styles y:axis, N number *=prefix end, p=percent</span>
      <span class="ruby-string">&quot;&amp;chtt=Структура на индиректна продажба&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-comment"># chart title</span>
      <span class="ruby-string">&quot;&amp;chts=000000,18,c&quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-node">&quot;&amp;chl=#{ p }&quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-string">&quot;&amp;chdl=фонд за добивки|провизија на заст.|МПМ|РМ|остаток&quot;</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">sales_i</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">+</span> <span class="ruby-value">4</span>)[<span class="ruby-value">1</span>] = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Link</span>.<span class="ruby-identifier">new</span> <span class="ruby-constant">URI</span>.<span class="ruby-identifier">escape</span>(<span class="ruby-identifier">s</span>),
    <span class="ruby-string">&quot;Структура на индиректна продажба&quot;</span>, <span class="ruby-string">&#39;&#39;</span>

  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">21</span>).<span class="ruby-identifier">default_format</span> = <span class="ruby-identifier">line_i_fmt</span>[<span class="ruby-value">1</span>]
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">22</span>).<span class="ruby-identifier">default_format</span> = <span class="ruby-identifier">line_i_fmt</span>[<span class="ruby-value">6</span>]

  <span class="ruby-identifier">r</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">2</span>)
  <span class="ruby-identifier">r</span>[<span class="ruby-value">21</span>] = <span class="ruby-string">&#39;фонд&#39;</span>
  <span class="ruby-identifier">r</span>[<span class="ruby-value">22</span>] = <span class="ruby-identifier">arr_i</span>[<span class="ruby-value">0</span>]

  <span class="ruby-identifier">r</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">3</span>)
  <span class="ruby-identifier">r</span>[<span class="ruby-value">21</span>] = <span class="ruby-string">&#39;провизија&#39;</span>
  <span class="ruby-identifier">r</span>[<span class="ruby-value">22</span>] = <span class="ruby-identifier">arr_i</span>[<span class="ruby-value">1</span>]

  <span class="ruby-identifier">r</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">4</span>)
  <span class="ruby-identifier">r</span>[<span class="ruby-value">21</span>] = <span class="ruby-string">&#39;МПМ&#39;</span>
  <span class="ruby-identifier">r</span>[<span class="ruby-value">22</span>] = <span class="ruby-identifier">arr_i</span>[<span class="ruby-value">2</span>]

  <span class="ruby-identifier">r</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">5</span>)
  <span class="ruby-identifier">r</span>[<span class="ruby-value">21</span>] = <span class="ruby-string">&#39;РМ&#39;</span>
  <span class="ruby-identifier">r</span>[<span class="ruby-value">22</span>] = <span class="ruby-identifier">arr_i</span>[<span class="ruby-value">3</span>]

  <span class="ruby-identifier">r</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">6</span>)
  <span class="ruby-identifier">r</span>[<span class="ruby-value">21</span>] = <span class="ruby-string">&#39;остаток&#39;</span>
  <span class="ruby-identifier">r</span>[<span class="ruby-value">22</span>] = <span class="ruby-identifier">arr_i</span>[<span class="ruby-value">4</span>]

  <span class="ruby-comment"># derect</span>
  <span class="ruby-identifier">arr_d</span> = [ <span class="ruby-comment"># funds, commission, MPM, RM</span>
    <span class="ruby-identifier">sales_d</span>.<span class="ruby-identifier">inject</span>(<span class="ruby-value">0</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">sum</span>, <span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sum</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">sales</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">funds</span>[<span class="ruby-identifier">s</span>.<span class="ruby-identifier">game_id</span>.<span class="ruby-identifier">to_s</span>] },
    <span class="ruby-identifier">sales_d</span>.<span class="ruby-identifier">inject</span>(<span class="ruby-value">0</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">sum</span>, <span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sum</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">sales</span> <span class="ruby-operator">*</span> <span class="ruby-constant">RM_PERC</span> },
  ]

  <span class="ruby-identifier">arr_d</span> <span class="ruby-operator">&lt;&lt;</span> (<span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">sales_d</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>)[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">5</span>] <span class="ruby-operator">-</span> <span class="ruby-identifier">arr_d</span>.<span class="ruby-identifier">inject</span>(<span class="ruby-value">0</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">sum</span>, <span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sum</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">s</span> })
  <span class="ruby-identifier">tot_d</span> = <span class="ruby-identifier">arr_d</span>.<span class="ruby-identifier">inject</span>(<span class="ruby-value">0</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">sum</span>, <span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sum</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">s</span> }
  <span class="ruby-identifier">p</span> = <span class="ruby-identifier">sprintf</span> <span class="ruby-string">&quot;%5.2f%%|%5.2f%%|%5.2f%%&quot;</span>, <span class="ruby-identifier">arr_d</span>[<span class="ruby-value">0</span>]<span class="ruby-operator">/</span><span class="ruby-identifier">tot_d</span><span class="ruby-operator">*</span><span class="ruby-value">100</span>,
              <span class="ruby-identifier">arr_d</span>[<span class="ruby-value">1</span>]<span class="ruby-operator">/</span><span class="ruby-identifier">tot_d</span><span class="ruby-operator">*</span><span class="ruby-value">100</span>,
              <span class="ruby-identifier">arr_d</span>[<span class="ruby-value">2</span>]<span class="ruby-operator">/</span><span class="ruby-identifier">tot_d</span><span class="ruby-operator">*</span><span class="ruby-value">100</span>
  <span class="ruby-identifier">s</span> = <span class="ruby-string">&quot;https://chart.googleapis.com/chart&quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-string">&quot;?chs=720x400&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-comment"># chart size</span>
      <span class="ruby-string">&quot;&amp;chma=10,60,40,10&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-comment"># chart margins</span>
      <span class="ruby-string">&quot;&amp;cht=p&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-comment"># 2d pie chart</span>
      <span class="ruby-node">&quot;&amp;chco=#{ cat10_colors[0..2].join &#39;,&#39; }&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-comment"># series color</span>
      <span class="ruby-node">&quot;&amp;chd=t:#{ arr_d.map {|x| x.to_i}.join &#39;,&#39; }&quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-string">&quot;&amp;chds=a&quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-string">&quot;&amp;chxt=x&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-comment"># axis labels</span>
      <span class="ruby-string">&quot;&amp;chxs=0,000000,14&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-comment"># axis label styles y:axis, N number *=prefix end, p=percent</span>
      <span class="ruby-string">&quot;&amp;chtt=Структура на директна продажба&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-comment"># chart title</span>
      <span class="ruby-string">&quot;&amp;chts=000000,18,c&quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-node">&quot;&amp;chl=#{ p }&quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-string">&quot;&amp;chdl=фонд за добивки|РМ|остаток&quot;</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">sales_d</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">+</span> <span class="ruby-value">4</span>)[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>] = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Link</span>.<span class="ruby-identifier">new</span> <span class="ruby-constant">URI</span>.<span class="ruby-identifier">escape</span>(<span class="ruby-identifier">s</span>),
    <span class="ruby-string">&quot;Структура на директна продажба&quot;</span>, <span class="ruby-string">&#39;&#39;</span>

  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">24</span>).<span class="ruby-identifier">default_format</span> = <span class="ruby-identifier">line_i_fmt</span>[<span class="ruby-value">1</span>]
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">25</span>).<span class="ruby-identifier">default_format</span> = <span class="ruby-identifier">line_i_fmt</span>[<span class="ruby-value">6</span>]

  <span class="ruby-identifier">r</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">2</span>)
  <span class="ruby-identifier">r</span>[<span class="ruby-value">24</span>] = <span class="ruby-string">&#39;фонд&#39;</span>
  <span class="ruby-identifier">r</span>[<span class="ruby-value">25</span>] = <span class="ruby-identifier">arr_d</span>[<span class="ruby-value">0</span>]

  <span class="ruby-identifier">r</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">3</span>)
  <span class="ruby-identifier">r</span>[<span class="ruby-value">24</span>] = <span class="ruby-string">&#39;РМ&#39;</span>
  <span class="ruby-identifier">r</span>[<span class="ruby-value">25</span>] = <span class="ruby-identifier">arr_d</span>[<span class="ruby-value">1</span>]

  <span class="ruby-identifier">r</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">4</span>)
  <span class="ruby-identifier">r</span>[<span class="ruby-value">24</span>] = <span class="ruby-string">&#39;остаток&#39;</span>
  <span class="ruby-identifier">r</span>[<span class="ruby-value">25</span>] = <span class="ruby-identifier">arr_d</span>[<span class="ruby-value">2</span>]

<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-create_sales_per_city_sheet" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">create_sales_per_city_sheet</span><span
            class="method-args">(book, day)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Create sheets for sales per city</p>
          
          

          
          <div class="method-source-code" id="create_sales_per_city_sheet-source">
            <pre><span class="ruby-comment"># File lib/comp/utils.rb, line 1545</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">create_sales_per_city_sheet</span> <span class="ruby-identifier">book</span>, <span class="ruby-identifier">day</span>

  <span class="ruby-comment"># create the worksheet</span>
  <span class="ruby-identifier">sheet</span>   = <span class="ruby-identifier">book</span>.<span class="ruby-identifier">create_worksheet</span> <span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;Продажба по градови&#39;</span>

  <span class="ruby-comment"># Formating</span>
  <span class="ruby-identifier">font</span>      =  <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>) 
  <span class="ruby-identifier">font_sm</span>   =  <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>, <span class="ruby-identifier">size</span><span class="ruby-operator">:</span> <span class="ruby-value">8</span>) 
  <span class="ruby-identifier">bold_font_sm</span> =  <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>, <span class="ruby-identifier">size</span><span class="ruby-operator">:</span> <span class="ruby-value">8</span>, <span class="ruby-identifier">bold</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>) 
  <span class="ruby-identifier">bold_font</span> =  <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>, <span class="ruby-identifier">bold</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>) 

  <span class="ruby-comment"># fix some columns widths</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">25</span> 
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">15</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">2</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">10</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">3</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">10</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">4</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">12</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">5</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">12</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">6</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">12</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">7</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">10</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">8</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">50</span>


  <span class="ruby-identifier">total_sales</span> = <span class="ruby-constant">Sale</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;date BETWEEN date(:day, &#39;start of month&#39;) AND :day&quot;</span>, <span class="ruby-identifier">day</span><span class="ruby-operator">:</span> <span class="ruby-identifier">day</span>).
                  <span class="ruby-identifier">sum</span>(<span class="ruby-value">:sales</span>)

  <span class="ruby-comment"># top 2 rows:</span>
  <span class="ruby-identifier">fmt</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">weight</span><span class="ruby-operator">:</span> <span class="ruby-value">:bold</span>,
    <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>, <span class="ruby-identifier">bold</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>, <span class="ruby-identifier">size</span><span class="ruby-operator">:</span> <span class="ruby-value">12</span>)
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">default_format</span> = <span class="ruby-identifier">fmt</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">height</span> = <span class="ruby-value">18</span>

  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">default_format</span> = <span class="ruby-identifier">fmt</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">height</span> = <span class="ruby-value">18</span>

  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">0</span>)[<span class="ruby-value">0</span>] = <span class="ruby-node">&quot;Период: #{ (day - (day.day - 1)).strftime YMD_FMT } --&quot;</span> <span class="ruby-operator">+</span>
                    <span class="ruby-node">&quot; #{ day.strftime YMD_FMT }&quot;</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">1</span>)[<span class="ruby-value">0</span>] = <span class="ruby-node">&quot;Вкупна уплата: #{ thou_sep(total_sales.to_i) }&quot;</span>

  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">merge_cells</span> <span class="ruby-value">0</span>, <span class="ruby-value">0</span>, <span class="ruby-value">0</span>, <span class="ruby-value">8</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">merge_cells</span> <span class="ruby-value">1</span>, <span class="ruby-value">0</span>, <span class="ruby-value">1</span>, <span class="ruby-value">8</span>

  <span class="ruby-comment"># heading</span>
  <span class="ruby-identifier">fmt_c</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">text_wrap</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>, <span class="ruby-identifier">vertical_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:middle</span>, <span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>,
        <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">bold_font</span>)
  <span class="ruby-identifier">fmt_l</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">text_wrap</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>, <span class="ruby-identifier">vertical_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:middle</span>, <span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>,
        <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:left</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">bold_font</span>)
  <span class="ruby-identifier">fmt_r</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">text_wrap</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>, <span class="ruby-identifier">vertical_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:middle</span>, <span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>,
        <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">bold_font</span>)
  <span class="ruby-identifier">heading_fmt</span>  = [<span class="ruby-identifier">fmt_l</span>, <span class="ruby-identifier">fmt_r</span>, <span class="ruby-identifier">fmt_c</span>, <span class="ruby-identifier">fmt_c</span>, <span class="ruby-identifier">fmt_r</span>, <span class="ruby-identifier">fmt_r</span>, <span class="ruby-identifier">fmt_r</span>, <span class="ruby-identifier">fmt_c</span>, <span class="ruby-identifier">fmt_r</span>]
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">3</span>).<span class="ruby-identifier">push</span> <span class="ruby-operator">*</span><span class="ruby-node">%W{град  продажба учество бр.терм. мин. прос. макс. id терминал}</span>
  <span class="ruby-value">0</span>.<span class="ruby-identifier">upto</span>(<span class="ruby-value">8</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">3</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">i</span>, <span class="ruby-identifier">heading_fmt</span>[<span class="ruby-identifier">i</span>] }
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">3</span>).<span class="ruby-identifier">height</span> = <span class="ruby-value">24</span>

  <span class="ruby-comment"># rows</span>
  <span class="ruby-identifier">row</span> = <span class="ruby-value">4</span>
  <span class="ruby-identifier">term_sales</span> = <span class="ruby-constant">Sale</span>.
        <span class="ruby-identifier">select</span>(<span class="ruby-string">&#39;s.terminal_id AS terminal_id, t.name AS name,&#39;</span> <span class="ruby-operator">+</span>
               <span class="ruby-string">&#39; t.city AS city, SUM(s.sales) AS sales&#39;</span>).
        <span class="ruby-identifier">joins</span>(<span class="ruby-string">&#39;AS s INNER JOIN terminals AS t ON s.terminal_id = t.id&#39;</span>).
        <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;s.date BETWEEN date(:day, &#39;start of month&#39;) AND :day&quot;</span>, <span class="ruby-identifier">day</span><span class="ruby-operator">:</span> <span class="ruby-identifier">day</span>).
        <span class="ruby-identifier">where</span>(<span class="ruby-string">&#39;s.sales &gt; 0.0&#39;</span>).
        <span class="ruby-identifier">group</span>(<span class="ruby-string">&#39;s.terminal_id&#39;</span>).<span class="ruby-identifier">to_a</span>

  <span class="ruby-identifier">qry</span> =<span class="ruby-value">&lt;&lt;-EOT
    SELECT
      ts.city                         AS city,
      SUM(ts.sales)                   AS city_sales,
      COUNT(DISTINCT ts.terminal_id)  AS term_count,
      MIN(ts.sales)                   AS min_term_sales,
      AVG(ts.sales)                   AS avg_term_sales,
      MAX(ts.sales)                   AS max_term_sales
    FROM (
      SELECT
        s.terminal_id   AS terminal_id,
        t.city          AS city,
        SUM(s.sales)    AS sales
      FROM
        sales AS s 
        INNER JOIN terminals AS t
          ON s.terminal_id = t.id
      WHERE
        s.date BETWEEN date(&#39;#{ day.strftime YMD_FMT }&#39;, &#39;start of month&#39;) AND 
        &#39;#{ day.strftime YMD_FMT }&#39;
        AND s.sales &gt; 0
      GROUP BY s.terminal_id
    ) AS ts
    GROUP BY ts.city
    ORDER BY term_count DESC
  EOT</span>

  <span class="ruby-comment"># ActiveRecord::Base.logger = Logger.new(STDOUT)</span>
  <span class="ruby-identifier">city_sales</span> = <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span> <span class="ruby-identifier">qry</span>, <span class="ruby-identifier">day</span><span class="ruby-operator">:</span> <span class="ruby-identifier">day</span>

  <span class="ruby-identifier">line_fmt</span> = [
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:left</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>,  <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#0.00%&#39;</span>,   <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,   <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,   <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,   <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,   <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
  ]

  <span class="ruby-identifier">city_sales</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">r</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span> <span class="ruby-identifier">row</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-value">0</span>] = <span class="ruby-identifier">s</span>[<span class="ruby-string">&#39;city&#39;</span>]
    <span class="ruby-identifier">r</span>[<span class="ruby-value">1</span>] = <span class="ruby-identifier">s</span>[<span class="ruby-string">&#39;city_sales&#39;</span>]
    <span class="ruby-identifier">r</span>[<span class="ruby-value">2</span>] = <span class="ruby-identifier">s</span>[<span class="ruby-string">&#39;city_sales&#39;</span>]<span class="ruby-operator">*</span><span class="ruby-value">1.0</span><span class="ruby-operator">/</span><span class="ruby-identifier">total_sales</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-value">3</span>] = <span class="ruby-identifier">s</span>[<span class="ruby-string">&#39;term_count&#39;</span>]
    <span class="ruby-identifier">r</span>[<span class="ruby-value">4</span>] = <span class="ruby-identifier">s</span>[<span class="ruby-string">&#39;min_term_sales&#39;</span>]
    <span class="ruby-identifier">r</span>[<span class="ruby-value">5</span>] = <span class="ruby-identifier">s</span>[<span class="ruby-string">&#39;avg_term_sales&#39;</span>]
    <span class="ruby-identifier">r</span>[<span class="ruby-value">6</span>] = <span class="ruby-identifier">s</span>[<span class="ruby-string">&#39;max_term_sales&#39;</span>]

    <span class="ruby-identifier">t</span> = <span class="ruby-identifier">term_sales</span>.<span class="ruby-identifier">select</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">ts</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ts</span>[<span class="ruby-string">&#39;city&#39;</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">s</span>[<span class="ruby-string">&#39;city&#39;</span>] <span class="ruby-keyword">and</span> <span class="ruby-identifier">ts</span>[<span class="ruby-string">&#39;sales&#39;</span>] <span class="ruby-operator">&gt;=</span> <span class="ruby-identifier">s</span>[<span class="ruby-string">&#39;max_term_sales&#39;</span>]}[<span class="ruby-value">0</span>]
    <span class="ruby-identifier">r</span>[<span class="ruby-value">7</span>] = <span class="ruby-identifier">t</span>[<span class="ruby-string">&#39;terminal_id&#39;</span>]
    <span class="ruby-identifier">r</span>[<span class="ruby-value">8</span>] = <span class="ruby-identifier">t</span>[<span class="ruby-string">&#39;name&#39;</span>]

    <span class="ruby-value">0</span>.<span class="ruby-identifier">upto</span>(<span class="ruby-value">8</span>) {<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">i</span>, <span class="ruby-identifier">line_fmt</span>[<span class="ruby-identifier">i</span>]}
    <span class="ruby-identifier">row</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
  <span class="ruby-keyword">end</span>

<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-create_share_sheet" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">create_share_sheet</span><span
            class="method-args">(book, day)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Share sheet</p>
          
          

          
          <div class="method-source-code" id="create_share_sheet-source">
            <pre><span class="ruby-comment"># File lib/comp/utils.rb, line 359</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">create_share_sheet</span> <span class="ruby-identifier">book</span>, <span class="ruby-identifier">day</span>
  
  <span class="ruby-identifier">sheet</span> = <span class="ruby-identifier">book</span>.<span class="ruby-identifier">create_worksheet</span> <span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;Учество&#39;</span>

  <span class="ruby-comment"># worksheet default format</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">default_format</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>)

  <span class="ruby-comment"># Formating</span>
  <span class="ruby-identifier">font</span>      =  <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>) 
  <span class="ruby-identifier">font_sm</span>   =  <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>, <span class="ruby-identifier">size</span><span class="ruby-operator">:</span> <span class="ruby-value">8</span>) 
  <span class="ruby-identifier">bold_font_sm</span> =  <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>, <span class="ruby-identifier">size</span><span class="ruby-operator">:</span> <span class="ruby-value">8</span>, <span class="ruby-identifier">bold</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>) 
  <span class="ruby-identifier">bold_font</span> =  <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>, <span class="ruby-identifier">bold</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>) 
  <span class="ruby-identifier">line_fmt</span>  = [
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:left</span>,  <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,   <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,   <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,   <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#0.00%&#39;</span>,   <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font_sm</span>),
  ]
  <span class="ruby-identifier">lastln_fmt</span>  = [
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:left</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,
      <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,
      <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,
      <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#0.00%&#39;</span>,
      <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font_sm</span>),
  ]
  <span class="ruby-identifier">totperc_fmt</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, 
                <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#0.00%&#39;</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">bold_font_sm</span>)
  <span class="ruby-identifier">bold_font</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;droid sans&#39;</span>, <span class="ruby-identifier">bold</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>) 
  <span class="ruby-identifier">total_fmt</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,
                <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">bold_font</span>)
  <span class="ruby-identifier">title_fmt</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">weight</span><span class="ruby-operator">:</span> <span class="ruby-value">:bold</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, 
            <span class="ruby-identifier">text_wrap</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>, <span class="ruby-identifier">vertical_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:middle</span>, <span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>,
            <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>, <span class="ruby-identifier">bold</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>, <span class="ruby-identifier">size</span><span class="ruby-operator">:</span> <span class="ruby-value">12</span>)

  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">width</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">7</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">3</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">width</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">8</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">20</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">2</span>).<span class="ruby-identifier">width</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">9</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">14</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">3</span>).<span class="ruby-identifier">width</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">10</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">12</span>

  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">height</span> = <span class="ruby-value">20</span>
  
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">push</span> <span class="ruby-operator">*</span>[ <span class="ruby-string">&quot;id&quot;</span>, <span class="ruby-string">&quot;игра&quot;</span>, <span class="ruby-string">&quot;пари&quot;</span>, <span class="ruby-string">&quot;тикети / комб.&quot;</span>, <span class="ruby-string">&quot;бр. терм.&quot;</span>, <span class="ruby-string">&quot;удел&quot;</span>, <span class="ruby-string">&#39;&#39;</span>,
                       <span class="ruby-string">&quot;id&quot;</span>, <span class="ruby-string">&quot;игра&quot;</span>, <span class="ruby-string">&quot;пари&quot;</span>, <span class="ruby-string">&quot;тикети / комб.&quot;</span>, <span class="ruby-string">&quot;бр. терм.&quot;</span>, <span class="ruby-string">&quot;удел&quot;</span>]
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">height</span> = <span class="ruby-value">25</span>
  <span class="ruby-identifier">heading_fmt</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">weight</span><span class="ruby-operator">:</span> <span class="ruby-value">:bold</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, 
            <span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, <span class="ruby-identifier">text_wrap</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>, <span class="ruby-identifier">vertical_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:middle</span>, 
            <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>, <span class="ruby-identifier">bold</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>)
  <span class="ruby-value">0</span>.<span class="ruby-identifier">upto</span>(<span class="ruby-value">5</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">i</span>, <span class="ruby-identifier">heading_fmt</span>
                  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">+</span> <span class="ruby-value">7</span>, <span class="ruby-identifier">heading_fmt</span> }

  <span class="ruby-identifier">qry</span> =<span class="ruby-value">&lt;&lt;-EOT
    g.id                    AS game_id,
    g.name                  AS name,
    g.price                 AS price,
    CASE 
      WHEN g.type = &#39;INSTANT&#39; THEN 1
      ELSE 0
    END                     AS is_instant,
    CASE
      WHEN g.parent IS NOT NULL THEN g.parent
      ELSE g.id
    END                     AS parent_id,
    SUM(s.sales)            AS sales,
    SUM(s.sales) / g.price  AS qty,
    COUNT(DISTINCT t.id)    AS term_count
  EOT</span>

  <span class="ruby-identifier">sales</span> = <span class="ruby-constant">Sale</span>.<span class="ruby-identifier">select</span>(<span class="ruby-identifier">qry</span>).
        <span class="ruby-identifier">joins</span>(<span class="ruby-string">&#39;AS s INNER JOIN games AS g ON s.game_id = g.id&#39;</span>).
        <span class="ruby-identifier">joins</span>(<span class="ruby-string">&#39;INNER JOIN terminals AS t ON s.terminal_id = t.id&#39;</span>)
  <span class="ruby-identifier">sales_i</span> = <span class="ruby-identifier">sales</span>.      
        <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;s.date BETWEEN date(:day, &#39;start of month&#39;) AND :day&quot;</span>, <span class="ruby-identifier">day</span><span class="ruby-operator">:</span> <span class="ruby-identifier">day</span>). 
        <span class="ruby-identifier">where</span>(<span class="ruby-string">&#39;t.agent_id &lt;&gt; 225&#39;</span>).
        <span class="ruby-identifier">group</span>(<span class="ruby-string">&#39;g.id&#39;</span>).
        <span class="ruby-identifier">having</span>(<span class="ruby-string">&#39;qty &gt; 0&#39;</span>).
        <span class="ruby-identifier">order</span>(<span class="ruby-string">&#39;is_instant, parent_id, g.id&#39;</span>)
  <span class="ruby-identifier">sales_d</span> = <span class="ruby-identifier">sales</span>.      
        <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;s.date BETWEEN date(:day, &#39;start of month&#39;) AND :day&quot;</span>, <span class="ruby-identifier">day</span><span class="ruby-operator">:</span> <span class="ruby-identifier">day</span>). 
        <span class="ruby-identifier">where</span>(<span class="ruby-string">&#39;t.agent_id = 225&#39;</span>).
        <span class="ruby-identifier">group</span>(<span class="ruby-string">&#39;g.id&#39;</span>).
        <span class="ruby-identifier">having</span>(<span class="ruby-string">&#39;qty &gt; 0&#39;</span>).
        <span class="ruby-identifier">order</span>(<span class="ruby-string">&#39;is_instant, parent_id, g.id&#39;</span>)

  <span class="ruby-comment"># indirect</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">0</span>)[<span class="ruby-value">0</span>] = <span class="ruby-node">&quot;Индиректна продажба, #{ MONTH_NAMES_MK[day.month] } #{ day.year }&quot;</span>
  <span class="ruby-value">0</span>.<span class="ruby-identifier">upto</span>(<span class="ruby-value">5</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">c</span>, <span class="ruby-identifier">title_fmt</span> }
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">merge_cells</span> <span class="ruby-value">0</span>, <span class="ruby-value">0</span>, <span class="ruby-value">0</span>, <span class="ruby-value">5</span>
  <span class="ruby-identifier">sales_i</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">s</span>, <span class="ruby-identifier">idx</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">r</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span> <span class="ruby-value">2</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">idx</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-value">0</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">game_id</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-value">1</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">name</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-value">2</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">sales</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-value">3</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">qty</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-value">4</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">term_count</span>
    <span class="ruby-identifier">dir</span> = <span class="ruby-identifier">sales_d</span>.<span class="ruby-identifier">select</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">ds</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ds</span>.<span class="ruby-identifier">game_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">game_id</span> }[<span class="ruby-value">0</span>]
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">dir</span>
      <span class="ruby-identifier">r</span>[<span class="ruby-value">5</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">sales</span> <span class="ruby-operator">/</span> (<span class="ruby-identifier">s</span>.<span class="ruby-identifier">sales</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">dir</span>.<span class="ruby-identifier">sales</span>)
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">ln_fmt</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">idx</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">sales_i</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span> <span class="ruby-keyword">then</span> <span class="ruby-identifier">lastln_fmt</span> <span class="ruby-keyword">else</span> <span class="ruby-identifier">line_fmt</span> <span class="ruby-keyword">end</span>
    <span class="ruby-value">0</span>.<span class="ruby-identifier">upto</span>(<span class="ruby-value">5</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">i</span>, <span class="ruby-identifier">ln_fmt</span>[<span class="ruby-identifier">i</span>] }
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">compare_total_for</span> <span class="ruby-identifier">sheet</span>, <span class="ruby-identifier">sales_i</span>, <span class="ruby-identifier">sales_i</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>, <span class="ruby-value">1</span>

  <span class="ruby-comment"># direct</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">0</span>)[<span class="ruby-value">7</span>] = <span class="ruby-node">&quot;Директна продажба, #{ MONTH_NAMES_MK[day.month] } #{ day.year }&quot;</span>
  <span class="ruby-value">7</span>.<span class="ruby-identifier">upto</span>(<span class="ruby-value">12</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">c</span>, <span class="ruby-identifier">title_fmt</span> }
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">merge_cells</span> <span class="ruby-value">0</span>, <span class="ruby-value">7</span>, <span class="ruby-value">0</span>, <span class="ruby-value">12</span>
  <span class="ruby-identifier">off</span> = <span class="ruby-value">7</span>
  <span class="ruby-identifier">sales_d</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">s</span>, <span class="ruby-identifier">idx</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">r</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span> <span class="ruby-value">2</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">idx</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">0</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">game_id</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">name</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">sales</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">3</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">qty</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">4</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">term_count</span>
    <span class="ruby-identifier">ind</span> = <span class="ruby-identifier">sales_i</span>.<span class="ruby-identifier">select</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">is</span><span class="ruby-operator">|</span> <span class="ruby-identifier">is</span>.<span class="ruby-identifier">game_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">game_id</span> }[<span class="ruby-value">0</span>]
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">ind</span>
      <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">5</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">sales</span> <span class="ruby-operator">/</span> (<span class="ruby-identifier">s</span>.<span class="ruby-identifier">sales</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">ind</span>.<span class="ruby-identifier">sales</span>)
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">ln_fmt</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">idx</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">sales_d</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span> <span class="ruby-keyword">then</span> <span class="ruby-identifier">lastln_fmt</span> <span class="ruby-keyword">else</span> <span class="ruby-identifier">line_fmt</span> <span class="ruby-keyword">end</span>
    <span class="ruby-value">0</span>.<span class="ruby-identifier">upto</span>(<span class="ruby-value">5</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">r</span>.<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">i</span>, <span class="ruby-identifier">ln_fmt</span>[<span class="ruby-identifier">i</span>] }
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">compare_total_for</span> <span class="ruby-identifier">sheet</span>, <span class="ruby-identifier">sales_d</span>, <span class="ruby-identifier">sales_d</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>, <span class="ruby-value">8</span>

  <span class="ruby-comment"># total share</span>
  <span class="ruby-identifier">row_i</span> = <span class="ruby-identifier">sales_i</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>
  <span class="ruby-identifier">row_d</span> = <span class="ruby-identifier">sales_d</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_i</span>)[<span class="ruby-value">5</span>] = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_i</span>)[<span class="ruby-value">2</span>] <span class="ruby-operator">/</span> (<span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_i</span>)[<span class="ruby-value">2</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_d</span>)[<span class="ruby-value">9</span>])
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_i</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>)[<span class="ruby-value">5</span>] = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_i</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>)[<span class="ruby-value">2</span>] <span class="ruby-operator">/</span> 
        (<span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_i</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>)[<span class="ruby-value">2</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_d</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>)[<span class="ruby-value">9</span>])
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_i</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>)[<span class="ruby-value">5</span>] = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_i</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>)[<span class="ruby-value">2</span>] <span class="ruby-operator">/</span> 
        (<span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_i</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>)[<span class="ruby-value">2</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_d</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>)[<span class="ruby-value">9</span>])
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_i</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-value">5</span>, <span class="ruby-identifier">totperc_fmt</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_i</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-value">5</span>, <span class="ruby-identifier">totperc_fmt</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_i</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-value">5</span>, <span class="ruby-identifier">totperc_fmt</span>

  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_d</span>)[<span class="ruby-value">12</span>] = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_d</span>)[<span class="ruby-value">9</span>] <span class="ruby-operator">/</span> (<span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_i</span>)[<span class="ruby-value">2</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_d</span>)[<span class="ruby-value">9</span>])
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_d</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>)[<span class="ruby-value">12</span>] = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_d</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>)[<span class="ruby-value">9</span>] <span class="ruby-operator">/</span> 
        (<span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_i</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>)[<span class="ruby-value">2</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_d</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>)[<span class="ruby-value">9</span>])
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_d</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>)[<span class="ruby-value">12</span>] = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_d</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>)[<span class="ruby-value">9</span>] <span class="ruby-operator">/</span> 
        (<span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_i</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>)[<span class="ruby-value">2</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_d</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>)[<span class="ruby-value">9</span>])
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_d</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-value">12</span>, <span class="ruby-identifier">totperc_fmt</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_d</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-value">12</span>, <span class="ruby-identifier">totperc_fmt</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_d</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-value">12</span>, <span class="ruby-identifier">totperc_fmt</span>

  <span class="ruby-identifier">qry</span> =<span class="ruby-value">&lt;&lt;-EOT
    CASE 
      WHEN g.type = &#39;INSTANT&#39; THEN 1
      ELSE 0
    END                     AS is_instant,
    SUM(s.sales)            AS sales,
    COUNT(DISTINCT t.id)    AS term_count
  EOT</span>
  <span class="ruby-identifier">sales</span> = <span class="ruby-constant">Sale</span>.<span class="ruby-identifier">select</span>(<span class="ruby-identifier">qry</span>).
        <span class="ruby-identifier">joins</span>(<span class="ruby-string">&#39;AS s INNER JOIN games AS g ON s.game_id = g.id&#39;</span>).
        <span class="ruby-identifier">joins</span>(<span class="ruby-string">&#39;INNER JOIN terminals AS t ON s.terminal_id = t.id&#39;</span>)
  <span class="ruby-identifier">term_i</span> = <span class="ruby-identifier">sales</span>.      
        <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;s.date BETWEEN date(:day, &#39;start of month&#39;) AND :day&quot;</span>, <span class="ruby-identifier">day</span><span class="ruby-operator">:</span> <span class="ruby-identifier">day</span>). 
        <span class="ruby-identifier">where</span>(<span class="ruby-string">&#39;t.agent_id &lt;&gt; 225&#39;</span>).
        <span class="ruby-identifier">where</span>(<span class="ruby-string">&#39;s.sales &gt; 0&#39;</span>).
        <span class="ruby-identifier">group</span>(<span class="ruby-string">&#39;is_instant&#39;</span>).
        <span class="ruby-identifier">order</span>(<span class="ruby-string">&#39;is_instant&#39;</span>)
  <span class="ruby-identifier">term_d</span> = <span class="ruby-identifier">sales</span>.      
        <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;s.date BETWEEN date(:day, &#39;start of month&#39;) AND :day&quot;</span>, <span class="ruby-identifier">day</span><span class="ruby-operator">:</span> <span class="ruby-identifier">day</span>). 
        <span class="ruby-identifier">where</span>(<span class="ruby-string">&#39;t.agent_id = 225&#39;</span>).
        <span class="ruby-identifier">where</span>(<span class="ruby-string">&#39;s.sales &gt; 0&#39;</span>).
        <span class="ruby-identifier">group</span>(<span class="ruby-string">&#39;is_instant&#39;</span>).
        <span class="ruby-identifier">order</span>(<span class="ruby-string">&#39;is_instant&#39;</span>)

  <span class="ruby-identifier">qry</span> =<span class="ruby-value">&lt;&lt;-EOT
    SUM(s.sales)            AS sales,
    COUNT(DISTINCT t.id)    AS term_count
  EOT</span>
  <span class="ruby-identifier">sales</span> = <span class="ruby-constant">Sale</span>.<span class="ruby-identifier">select</span>(<span class="ruby-identifier">qry</span>).
        <span class="ruby-identifier">joins</span>(<span class="ruby-string">&#39;AS s INNER JOIN terminals AS t ON s.terminal_id = t.id&#39;</span>)
  <span class="ruby-identifier">totterm_i</span> = <span class="ruby-identifier">sales</span>.
        <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;s.date BETWEEN date(:day, &#39;start of month&#39;) AND :day&quot;</span>, <span class="ruby-identifier">day</span><span class="ruby-operator">:</span> <span class="ruby-identifier">day</span>). 
        <span class="ruby-identifier">where</span>(<span class="ruby-string">&#39;t.agent_id &lt;&gt; 225&#39;</span>).
        <span class="ruby-identifier">where</span>(<span class="ruby-string">&#39;s.sales &gt; 0&#39;</span>)
  <span class="ruby-identifier">totterm_d</span> = <span class="ruby-identifier">sales</span>.
        <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;s.date BETWEEN date(:day, &#39;start of month&#39;) AND :day&quot;</span>, <span class="ruby-identifier">day</span><span class="ruby-operator">:</span> <span class="ruby-identifier">day</span>). 
        <span class="ruby-identifier">where</span>(<span class="ruby-string">&#39;t.agent_id = 225&#39;</span>).
        <span class="ruby-identifier">where</span>(<span class="ruby-string">&#39;s.sales &gt; 0&#39;</span>)

  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_i</span> <span class="ruby-operator">+</span> <span class="ruby-value">0</span>)[<span class="ruby-value">4</span>] = <span class="ruby-identifier">term_i</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">term_count</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_i</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>)[<span class="ruby-value">4</span>] = <span class="ruby-identifier">term_i</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">term_count</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_i</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>)[<span class="ruby-value">4</span>] = <span class="ruby-identifier">totterm_i</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">term_count</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_i</span> <span class="ruby-operator">+</span> <span class="ruby-value">0</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-value">4</span>, <span class="ruby-identifier">total_fmt</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_i</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-value">4</span>, <span class="ruby-identifier">total_fmt</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_i</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-value">4</span>, <span class="ruby-identifier">total_fmt</span>

  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_d</span> <span class="ruby-operator">+</span> <span class="ruby-value">0</span>)[<span class="ruby-value">11</span>] = <span class="ruby-identifier">term_d</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">term_count</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_d</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>)[<span class="ruby-value">11</span>] = <span class="ruby-identifier">term_d</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">term_count</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_d</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>)[<span class="ruby-value">11</span>] = <span class="ruby-identifier">totterm_d</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">term_count</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_d</span> <span class="ruby-operator">+</span> <span class="ruby-value">0</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-value">11</span>, <span class="ruby-identifier">total_fmt</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_d</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-value">11</span>, <span class="ruby-identifier">total_fmt</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_d</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-value">11</span>, <span class="ruby-identifier">total_fmt</span>

  <span class="ruby-comment"># google chart</span>
  <span class="ruby-identifier">total</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_i</span><span class="ruby-operator">+</span><span class="ruby-value">0</span>)[<span class="ruby-value">2</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_i</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>)[<span class="ruby-value">2</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">+</span>
          <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_d</span><span class="ruby-operator">+</span><span class="ruby-value">0</span>)[<span class="ruby-value">9</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_d</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>)[<span class="ruby-value">9</span>].<span class="ruby-identifier">to_i</span>

  <span class="ruby-identifier">p</span> = <span class="ruby-identifier">sprintf</span> <span class="ruby-string">&quot;%5.2f%%|%5.2f%%|%5.2f%%|%5.2f%%&quot;</span>, <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_i</span><span class="ruby-operator">+</span><span class="ruby-value">0</span>)[<span class="ruby-value">2</span>]<span class="ruby-operator">/</span><span class="ruby-identifier">total</span><span class="ruby-operator">*</span><span class="ruby-value">100</span>,
              <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_i</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>)[<span class="ruby-value">2</span>]<span class="ruby-operator">/</span><span class="ruby-identifier">total</span><span class="ruby-operator">*</span><span class="ruby-value">100</span>,
              <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_d</span><span class="ruby-operator">+</span><span class="ruby-value">0</span>)[<span class="ruby-value">9</span>]<span class="ruby-operator">/</span><span class="ruby-identifier">total</span><span class="ruby-operator">*</span><span class="ruby-value">100</span>,
              <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_d</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>)[<span class="ruby-value">9</span>]<span class="ruby-operator">/</span><span class="ruby-identifier">total</span><span class="ruby-operator">*</span><span class="ruby-value">100</span>

  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">14</span>).<span class="ruby-identifier">default_format</span> = <span class="ruby-identifier">line_fmt</span>[<span class="ruby-value">1</span>]
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">15</span>).<span class="ruby-identifier">default_format</span> = <span class="ruby-identifier">line_fmt</span>[<span class="ruby-value">2</span>]

  <span class="ruby-identifier">r</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">2</span>)
  <span class="ruby-identifier">r</span>[<span class="ruby-value">14</span>] = <span class="ruby-string">&#39;индиректна лото&#39;</span>
  <span class="ruby-identifier">r</span>[<span class="ruby-value">15</span>] = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_i</span> <span class="ruby-operator">+</span> <span class="ruby-value">0</span>)[<span class="ruby-value">2</span>]

  <span class="ruby-identifier">r</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">3</span>)
  <span class="ruby-identifier">r</span>[<span class="ruby-value">14</span>] = <span class="ruby-string">&#39;индиректна инстанти&#39;</span>
  <span class="ruby-identifier">r</span>[<span class="ruby-value">15</span>] = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_i</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>)[<span class="ruby-value">2</span>]

  <span class="ruby-identifier">r</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">4</span>)
  <span class="ruby-identifier">r</span>[<span class="ruby-value">14</span>] = <span class="ruby-string">&#39;директна лото&#39;</span>
  <span class="ruby-identifier">r</span>[<span class="ruby-value">15</span>] = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_d</span> <span class="ruby-operator">+</span> <span class="ruby-value">0</span>)[<span class="ruby-value">9</span>]

  <span class="ruby-identifier">r</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">5</span>)
  <span class="ruby-identifier">r</span>[<span class="ruby-value">14</span>] = <span class="ruby-string">&#39;директна инстанти&#39;</span>
  <span class="ruby-identifier">r</span>[<span class="ruby-value">15</span>] = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row_d</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>)[<span class="ruby-value">9</span>]
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-create_top_terminals_sheet" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">create_top_terminals_sheet</span><span
            class="method-args">(book, day, opt = {})</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Create sheets for top terminal sales per game</p>
          
          

          
          <div class="method-source-code" id="create_top_terminals_sheet-source">
            <pre><span class="ruby-comment"># File lib/comp/utils.rb, line 1429</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">create_top_terminals_sheet</span> <span class="ruby-identifier">book</span>, <span class="ruby-identifier">day</span>, <span class="ruby-identifier">opt</span> = {}

  <span class="ruby-comment"># top </span>
  <span class="ruby-identifier">top_count</span> = <span class="ruby-identifier">opt</span>[<span class="ruby-value">:top_count</span>]
  <span class="ruby-identifier">top_count</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">TOP_COUNT</span>

  <span class="ruby-comment"># create the worksheet</span>
  <span class="ruby-identifier">tt_sheet</span>   = <span class="ruby-identifier">book</span>.<span class="ruby-identifier">create_worksheet</span> <span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;Топ терминали&#39;</span>

  <span class="ruby-identifier">total_sales</span> = <span class="ruby-constant">Sale</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;date BETWEEN date(:day, &#39;start of month&#39;) AND :day&quot;</span>, <span class="ruby-identifier">day</span><span class="ruby-operator">:</span> <span class="ruby-identifier">day</span>).
                  <span class="ruby-identifier">sum</span>(<span class="ruby-value">:sales</span>)

  <span class="ruby-comment"># Formating</span>
  <span class="ruby-identifier">font</span>      =  <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>) 
  <span class="ruby-identifier">font_sm</span>   =  <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>, <span class="ruby-identifier">size</span><span class="ruby-operator">:</span> <span class="ruby-value">8</span>) 
  <span class="ruby-identifier">bold_font_sm</span> =  <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>, <span class="ruby-identifier">size</span><span class="ruby-operator">:</span> <span class="ruby-value">8</span>, <span class="ruby-identifier">bold</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>) 
  <span class="ruby-identifier">bold_font</span> =  <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>, <span class="ruby-identifier">bold</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>) 

  <span class="ruby-comment"># worksheet default format</span>
  <span class="ruby-identifier">tt_sheet</span>.<span class="ruby-identifier">default_format</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>)

  <span class="ruby-comment"># fix some columns widths</span>
  <span class="ruby-identifier">tt_sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">10</span> 
  <span class="ruby-identifier">tt_sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">75</span>
  <span class="ruby-identifier">tt_sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">2</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">20</span>
  <span class="ruby-identifier">tt_sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">3</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">20</span>
  <span class="ruby-identifier">tt_sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">4</span>).<span class="ruby-identifier">width</span> = <span class="ruby-value">15</span>

  <span class="ruby-comment"># top 2 rows:</span>
  <span class="ruby-identifier">fmt</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">weight</span><span class="ruby-operator">:</span> <span class="ruby-value">:bold</span>,
    <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>, <span class="ruby-identifier">bold</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>, <span class="ruby-identifier">size</span><span class="ruby-operator">:</span> <span class="ruby-value">12</span>)
  <span class="ruby-identifier">tt_sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">default_format</span> = <span class="ruby-identifier">fmt</span>
  <span class="ruby-identifier">tt_sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">height</span> = <span class="ruby-value">18</span>

  <span class="ruby-identifier">tt_sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">default_format</span> = <span class="ruby-identifier">fmt</span>
  <span class="ruby-identifier">tt_sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">height</span> = <span class="ruby-value">18</span>
    
  <span class="ruby-identifier">tt_sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">0</span>)[<span class="ruby-value">0</span>] = <span class="ruby-node">&quot;Период: #{ (day - (day.day - 1)).strftime YMD_FMT } --&quot;</span> <span class="ruby-operator">+</span>
                       <span class="ruby-node">&quot; #{ day.strftime YMD_FMT }&quot;</span>
  <span class="ruby-identifier">tt_sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">1</span>)[<span class="ruby-value">0</span>] = <span class="ruby-node">&quot;Вкупна уплата: #{ thou_sep(total_sales.to_i) }&quot;</span>
  <span class="ruby-identifier">tt_sheet</span>.<span class="ruby-identifier">merge_cells</span> <span class="ruby-value">0</span>, <span class="ruby-value">0</span>, <span class="ruby-value">0</span>, <span class="ruby-value">4</span>
  <span class="ruby-identifier">tt_sheet</span>.<span class="ruby-identifier">merge_cells</span> <span class="ruby-value">1</span>, <span class="ruby-value">0</span>, <span class="ruby-value">1</span>, <span class="ruby-value">4</span>

  <span class="ruby-identifier">fmt_c</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">text_wrap</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>, <span class="ruby-identifier">vertical_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:middle</span>, <span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>,
        <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">bold_font</span>)
  <span class="ruby-identifier">fmt_l</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">text_wrap</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>, <span class="ruby-identifier">vertical_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:middle</span>, <span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>,
        <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:left</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">bold_font</span>)
  <span class="ruby-identifier">fmt_r</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">text_wrap</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>, <span class="ruby-identifier">vertical_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:middle</span>, <span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>,
        <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">bold_font</span>)
  <span class="ruby-identifier">heading_fmt</span>  = [<span class="ruby-identifier">fmt_c</span>, <span class="ruby-identifier">fmt_l</span>, <span class="ruby-identifier">fmt_c</span>, <span class="ruby-identifier">fmt_r</span>, <span class="ruby-identifier">fmt_r</span>]
  <span class="ruby-identifier">tt_sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">3</span>).<span class="ruby-identifier">push</span> <span class="ruby-operator">*</span>[ <span class="ruby-string">&quot;id&quot;</span>, <span class="ruby-string">&quot;игра/терминал&quot;</span>, <span class="ruby-string">&quot;цена/град&quot;</span>, <span class="ruby-string">&quot;промет&quot;</span>, <span class="ruby-string">&quot;учество %&quot;</span> ]
  <span class="ruby-identifier">tt_sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">3</span>).<span class="ruby-identifier">height</span> = <span class="ruby-value">24</span>
  <span class="ruby-value">0</span>.<span class="ruby-identifier">upto</span>(<span class="ruby-value">5</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">tt_sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">3</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">i</span>, <span class="ruby-identifier">heading_fmt</span>[<span class="ruby-identifier">i</span>] }

  <span class="ruby-identifier">row</span> = <span class="ruby-value">4</span>
  <span class="ruby-identifier">game_sales</span> = <span class="ruby-constant">Sale</span>.
      <span class="ruby-identifier">select</span>(<span class="ruby-string">&#39;s.game_id AS game_id, g.name AS name, g.price AS price, SUM(s.sales) AS total_sales&#39;</span>).
      <span class="ruby-identifier">joins</span>(<span class="ruby-string">&#39;AS s INNER JOIN games AS g ON s.game_id = g.id&#39;</span>).
      <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;s.date BETWEEN date(:day, &#39;start of month&#39;) AND :day&quot;</span>, <span class="ruby-identifier">day</span><span class="ruby-operator">:</span> <span class="ruby-identifier">day</span>).
      <span class="ruby-identifier">where</span>(<span class="ruby-string">&#39;s.sales &gt; 0&#39;</span>).
      <span class="ruby-identifier">group</span>(<span class="ruby-string">&#39;s.game_id&#39;</span>).
      <span class="ruby-identifier">order</span>(<span class="ruby-string">&#39;s.game_id&#39;</span>)

  <span class="ruby-identifier">line_fmt_b</span> = [
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">bold_font</span>, <span class="ruby-identifier">vertical_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:middle</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:left</span>,  <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">bold_font</span>, <span class="ruby-identifier">vertical_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:middle</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">bold_font</span>, <span class="ruby-identifier">vertical_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:middle</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,
      <span class="ruby-identifier">vertical_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:middle</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">bold_font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#0.00%&#39;</span>,
      <span class="ruby-identifier">vertical_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:middle</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">bold_font</span>),
  ]
  <span class="ruby-identifier">line_fmt</span> = [
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:left</span>,  <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,   <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
    <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#0.00%&#39;</span>,   <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-identifier">font</span>),
  ]
  <span class="ruby-identifier">game_sales</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">g</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">r</span> = <span class="ruby-identifier">tt_sheet</span>.<span class="ruby-identifier">row</span> <span class="ruby-identifier">row</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-value">0</span>] = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">game_id</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-value">1</span>] = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">name</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-value">2</span>] = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">price</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-value">3</span>] = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">total_sales</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-value">4</span>] = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">total_sales</span><span class="ruby-operator">*</span><span class="ruby-value">1.0</span><span class="ruby-operator">/</span><span class="ruby-identifier">total_sales</span>
    <span class="ruby-value">0</span>.<span class="ruby-identifier">upto</span>(<span class="ruby-value">5</span>) {<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">tt_sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">i</span>, <span class="ruby-identifier">line_fmt_b</span>[<span class="ruby-identifier">i</span>]}
    <span class="ruby-identifier">r</span>.<span class="ruby-identifier">height</span> = <span class="ruby-value">18</span>
    <span class="ruby-identifier">row</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>

    <span class="ruby-identifier">top_terminals</span> = <span class="ruby-constant">Sale</span>.
      <span class="ruby-identifier">select</span>(<span class="ruby-string">&#39;s.terminal_id AS terminal_id, t.name AS name,&#39;</span> <span class="ruby-operator">+</span>
             <span class="ruby-string">&#39; t.city AS city, SUM(s.sales) AS total_sales&#39;</span>).
      <span class="ruby-identifier">joins</span>(<span class="ruby-string">&#39;AS s INNER JOIN terminals AS t ON s.terminal_id = t.id&#39;</span>).
      <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;s.date BETWEEN date(:day, &#39;start of month&#39;) AND :day&quot;</span>, <span class="ruby-identifier">day</span><span class="ruby-operator">:</span> <span class="ruby-identifier">day</span>).
      <span class="ruby-identifier">where</span>(<span class="ruby-string">&#39;s.game_id&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">g</span>.<span class="ruby-identifier">game_id</span>).
      <span class="ruby-identifier">where</span>(<span class="ruby-string">&#39;s.sales &gt; 0&#39;</span>).
      <span class="ruby-identifier">group</span>(<span class="ruby-string">&#39;s.terminal_id&#39;</span>).
      <span class="ruby-identifier">order</span>(<span class="ruby-string">&#39;total_sales DESC&#39;</span>).
      <span class="ruby-identifier">limit</span>(<span class="ruby-identifier">top_count</span>)
    <span class="ruby-identifier">top_terminals</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">tt</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">r</span> = <span class="ruby-identifier">tt_sheet</span>.<span class="ruby-identifier">row</span> <span class="ruby-identifier">row</span>
      <span class="ruby-identifier">r</span>[<span class="ruby-value">0</span>] = <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">terminal_id</span>
      <span class="ruby-identifier">r</span>[<span class="ruby-value">1</span>] = <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">name</span>
      <span class="ruby-identifier">r</span>[<span class="ruby-value">2</span>] = <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">city</span>
      <span class="ruby-identifier">r</span>[<span class="ruby-value">3</span>] = <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">total_sales</span>
      <span class="ruby-identifier">r</span>[<span class="ruby-value">4</span>] = <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">total_sales</span><span class="ruby-operator">*</span><span class="ruby-value">1.0</span><span class="ruby-operator">/</span><span class="ruby-identifier">g</span>.<span class="ruby-identifier">total_sales</span>
      <span class="ruby-value">0</span>.<span class="ruby-identifier">upto</span>(<span class="ruby-value">5</span>) {<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">tt_sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">row</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">i</span>, <span class="ruby-identifier">line_fmt</span>[<span class="ruby-identifier">i</span>]}
      <span class="ruby-identifier">row</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-create_weekly_sheet" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">create_weekly_sheet</span><span
            class="method-args">(book, day)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Weekly sales</p>
          
          

          
          <div class="method-source-code" id="create_weekly_sheet-source">
            <pre><span class="ruby-comment"># File lib/comp/utils.rb, line 921</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">create_weekly_sheet</span>(<span class="ruby-identifier">book</span>, <span class="ruby-identifier">day</span>)
  <span class="ruby-identifier">sheet</span> = <span class="ruby-identifier">book</span>.<span class="ruby-identifier">create_worksheet</span> <span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;Неделно&#39;</span>

  <span class="ruby-identifier">qry</span> =<span class="ruby-value">&lt;&lt;-EOT
    date(s.date, &#39;weekday 0&#39;, &#39;-6 days&#39;)      AS monday,
    date(s.date, &#39;weekday 0&#39;)                 AS sunday,
    CAST(strftime(&#39;%W&#39;, date(s.date, &#39;weekday 0&#39;)) AS INTEGER)
                                              AS week_number,
    SUM(s.sales)                              AS sales
    --- FROM sales AS s
  EOT</span>

  <span class="ruby-identifier">wsales_now</span> = <span class="ruby-constant">Sale</span>.<span class="ruby-identifier">select</span>(<span class="ruby-identifier">qry</span>).
        <span class="ruby-identifier">joins</span>(<span class="ruby-string">&#39;AS s&#39;</span>).
        <span class="ruby-identifier">where</span>(<span class="ruby-string">&#39;substr(sunday, 1, 4) = :year_s&#39;</span>, <span class="ruby-identifier">year_s</span><span class="ruby-operator">:</span> <span class="ruby-identifier">day</span>.<span class="ruby-identifier">year</span>.<span class="ruby-identifier">to_s</span>).
        <span class="ruby-identifier">group</span>(<span class="ruby-string">&#39;monday&#39;</span>, <span class="ruby-string">&#39;sunday&#39;</span>).<span class="ruby-identifier">having</span>(<span class="ruby-string">&#39;sunday &lt;= :day&#39;</span>, <span class="ruby-identifier">day</span><span class="ruby-operator">:</span> <span class="ruby-identifier">day</span>).
        <span class="ruby-identifier">order</span>(<span class="ruby-string">&#39;monday&#39;</span>)
  
  <span class="ruby-identifier">last_week</span> = <span class="ruby-identifier">wsales_now</span>[<span class="ruby-value">-1</span>].<span class="ruby-identifier">week_number</span> 

  <span class="ruby-identifier">wsales_before</span> = <span class="ruby-constant">Sale</span>.<span class="ruby-identifier">select</span>(<span class="ruby-identifier">qry</span>).
        <span class="ruby-identifier">joins</span>(<span class="ruby-string">&#39;AS s&#39;</span>).
        <span class="ruby-identifier">where</span>(<span class="ruby-string">&#39;substr(sunday, 1, 4) = :year_s&#39;</span>, <span class="ruby-identifier">year_s</span><span class="ruby-operator">:</span> (<span class="ruby-identifier">day</span>.<span class="ruby-identifier">year</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>).<span class="ruby-identifier">to_s</span>).
        <span class="ruby-identifier">group</span>(<span class="ruby-string">&#39;monday&#39;</span>, <span class="ruby-string">&#39;sunday&#39;</span>).
        <span class="ruby-identifier">having</span>(<span class="ruby-string">&#39;week_number &lt;= :week_number&#39;</span>, <span class="ruby-identifier">week_number</span><span class="ruby-operator">:</span> <span class="ruby-identifier">last_week</span>).
        <span class="ruby-identifier">order</span>(<span class="ruby-string">&#39;monday&#39;</span>)

  <span class="ruby-comment"># worksheet default format</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">default_format</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>)
  
  <span class="ruby-comment"># format date columns</span>
  <span class="ruby-identifier">date_fmt_mk</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;DD.MM.YYYY&#39;</span>, 
                <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>)
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">default_format</span> = <span class="ruby-identifier">date_fmt_mk</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">2</span>).<span class="ruby-identifier">default_format</span> = <span class="ruby-identifier">date_fmt_mk</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">6</span>).<span class="ruby-identifier">default_format</span> = <span class="ruby-identifier">date_fmt_mk</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">7</span>).<span class="ruby-identifier">default_format</span> = <span class="ruby-identifier">date_fmt_mk</span>

  <span class="ruby-comment"># format week number columns</span>
  <span class="ruby-identifier">week_number_fmt</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;00&#39;</span>,
                    <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>)
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">default_format</span> = <span class="ruby-identifier">week_number_fmt</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">5</span>).<span class="ruby-identifier">default_format</span> = <span class="ruby-identifier">week_number_fmt</span>

  <span class="ruby-comment"># sales format</span>
  <span class="ruby-identifier">sales_fmt</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:right</span>, <span class="ruby-identifier">number_format</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;#,###&#39;</span>,
              <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>)
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">3</span>).<span class="ruby-identifier">default_format</span> = <span class="ruby-identifier">sales_fmt</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">column</span>(<span class="ruby-value">8</span>).<span class="ruby-identifier">default_format</span> = <span class="ruby-identifier">sales_fmt</span>

  <span class="ruby-comment"># heading format</span>
  <span class="ruby-identifier">heading_fmt</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, <span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>, 
                <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>, <span class="ruby-identifier">bold</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>)
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">push</span> <span class="ruby-operator">*</span>[ <span class="ruby-string">&quot;седмица&quot;</span>, <span class="ruby-string">&quot;понед.&quot;</span>, <span class="ruby-string">&quot;недела&quot;</span>, <span class="ruby-string">&quot;уплата&quot;</span>, <span class="ruby-string">&quot;&quot;</span>,
                       <span class="ruby-string">&quot;седмица&quot;</span>, <span class="ruby-string">&quot;понед.&quot;</span>, <span class="ruby-string">&quot;недела&quot;</span>, <span class="ruby-string">&quot;уплата&quot;</span>, <span class="ruby-string">&quot;&quot;</span>,
                     ]
  [<span class="ruby-value">0</span>, <span class="ruby-value">1</span>, <span class="ruby-value">2</span>, <span class="ruby-value">3</span>, <span class="ruby-value">5</span>, <span class="ruby-value">6</span>, <span class="ruby-value">7</span>, <span class="ruby-value">8</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">c</span>, <span class="ruby-identifier">heading_fmt</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># title format</span>
  <span class="ruby-identifier">title_fmt</span> = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">weight</span><span class="ruby-operator">:</span> <span class="ruby-value">:bold</span>, <span class="ruby-identifier">horizontal_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:center</span>, 
            <span class="ruby-identifier">text_wrap</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>, <span class="ruby-identifier">vertical_align</span><span class="ruby-operator">:</span> <span class="ruby-value">:middle</span>, <span class="ruby-identifier">bottom</span><span class="ruby-operator">:</span> <span class="ruby-value">:thin</span>,
            <span class="ruby-identifier">font</span><span class="ruby-operator">:</span> <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Font</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;Droid Sans&#39;</span>, <span class="ruby-identifier">bold</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>, <span class="ruby-identifier">size</span><span class="ruby-operator">:</span> <span class="ruby-value">12</span>)
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">height</span> = <span class="ruby-value">20</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">0</span>)[<span class="ruby-value">0</span>] = <span class="ruby-node">&quot;Неделна продажба #{ day.year }&quot;</span>
  <span class="ruby-value">0</span>.<span class="ruby-identifier">upto</span>(<span class="ruby-value">3</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">c</span>, <span class="ruby-identifier">title_fmt</span> }
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">merge_cells</span> <span class="ruby-value">0</span>, <span class="ruby-value">0</span>, <span class="ruby-value">0</span>, <span class="ruby-value">3</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">0</span>)[<span class="ruby-value">5</span>] = <span class="ruby-node">&quot;Неделна продажба #{ day.year - 1 }&quot;</span>
  <span class="ruby-value">0</span>.<span class="ruby-identifier">upto</span>(<span class="ruby-value">8</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">set_format</span> <span class="ruby-identifier">c</span>, <span class="ruby-identifier">title_fmt</span> }
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">merge_cells</span> <span class="ruby-value">0</span>, <span class="ruby-value">5</span>, <span class="ruby-value">0</span>, <span class="ruby-value">8</span>

  <span class="ruby-identifier">wsales_now</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">s</span>, <span class="ruby-identifier">idx</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">r</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span> <span class="ruby-value">2</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">idx</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-value">0</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">week_number</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-value">1</span>] = <span class="ruby-constant">Date</span>.<span class="ruby-identifier">parse</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">monday</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-value">2</span>] = <span class="ruby-constant">Date</span>.<span class="ruby-identifier">parse</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">sunday</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-value">3</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">sales</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">off</span> = <span class="ruby-value">5</span>
  <span class="ruby-identifier">wsales_before</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">s</span>, <span class="ruby-identifier">idx</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">r</span> = <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span> <span class="ruby-value">2</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">idx</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">0</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">week_number</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>] = <span class="ruby-constant">Date</span>.<span class="ruby-identifier">parse</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">monday</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">2</span>] = <span class="ruby-constant">Date</span>.<span class="ruby-identifier">parse</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">sunday</span>
    <span class="ruby-identifier">r</span>[<span class="ruby-identifier">off</span> <span class="ruby-operator">+</span> <span class="ruby-value">3</span>] = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">sales</span>
  <span class="ruby-keyword">end</span>
  
  <span class="ruby-comment"># series: comma separated</span>
  <span class="ruby-identifier">ser_now</span>     = <span class="ruby-identifier">wsales_now</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">sales</span>.<span class="ruby-identifier">to_i</span> }.<span class="ruby-identifier">join</span>(<span class="ruby-string">&#39;,&#39;</span>)
  <span class="ruby-identifier">ser_before</span>  = <span class="ruby-identifier">wsales_before</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">sales</span>.<span class="ruby-identifier">to_i</span> }.<span class="ruby-identifier">join</span>(<span class="ruby-string">&#39;,&#39;</span>)

  <span class="ruby-comment"># google chart</span>
  <span class="ruby-identifier">s</span> = <span class="ruby-string">&quot;https://chart.googleapis.com/chart&quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-string">&quot;?chs=720x400&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-comment"># chart size</span>
      <span class="ruby-string">&quot;&amp;chma=60,30,30,30&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-comment"># chart margins</span>
      <span class="ruby-string">&quot;&amp;cht=lc&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-comment"># line chart</span>
      <span class="ruby-string">&quot;&amp;chco=e0440e,f6c7b6&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-comment"># series color</span>
      <span class="ruby-node">&quot;&amp;chd=t:#{ ser_now }|#{ ser_before }&quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-string">&quot;&amp;chxt=x,y&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-comment"># axis labels</span>
      <span class="ruby-string">&quot;&amp;chxs=1,N*s&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-comment"># axis label styles y:axis, N number *=prefix end, s=separated</span>
      <span class="ruby-node">&quot;&amp;chxl=0:|#{ (0 .. last_week).to_a.join(&#39;|&#39;) }&quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-string">&quot;&amp;chls=3|2&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-comment"># line style (thickness)</span>
      <span class="ruby-string">&quot;&amp;chds=a&quot;</span> <span class="ruby-operator">+</span>
      <span class="ruby-string">&quot;&amp;chtt=Споредба на неделен промет&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-comment"># chart title</span>
      <span class="ruby-string">&quot;&amp;chts=000000,18,c&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-comment"># chart style: color, size, align</span>
      <span class="ruby-string">&quot;&amp;chg=-1,-1,2,4&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-comment"># grid by axis tics</span>
      <span class="ruby-string">&quot;&amp;chxtc=0,5&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-comment"># tic style</span>
      <span class="ruby-string">&quot;&amp;chdlp=t&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-comment"># legend position</span>
      <span class="ruby-node">&quot;&amp;chdl=#{ day.year }|#{ day.year - 1 }&quot;</span> <span class="ruby-comment"># chart legend</span>
  <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">row</span>(<span class="ruby-identifier">last_week</span> <span class="ruby-operator">+</span> <span class="ruby-value">5</span>)[<span class="ruby-value">1</span>] = <span class="ruby-constant">Spreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Link</span>.<span class="ruby-identifier">new</span> <span class="ruby-constant">URI</span>.<span class="ruby-identifier">escape</span>(<span class="ruby-identifier">s</span>),
    <span class="ruby-string">&quot;График: Споредба на неделен промет&quot;</span>, <span class="ruby-string">&#39;&#39;</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-get_sales" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_sales</span><span
            class="method-args">(c)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="get_sales-source">
            <pre><span class="ruby-comment"># File lib/comp/utils.rb, line 38</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_sales</span>(<span class="ruby-identifier">c</span>)
  <span class="ruby-identifier">sel</span> =<span class="ruby-value">&lt;&lt;-EOT
    g.id                    AS game_id,
    g.name                  AS name,
    CASE 
      WHEN g.type = &#39;INSTANT&#39; THEN 1
      ELSE 0
    END                     AS is_instant,
    CASE
      WHEN g.parent IS NOT NULL THEN g.parent
      ELSE g.id
    END                     AS parent_id,
    SUM(s.sales)            AS sales,
    SUM(s.sales) / g.price  AS qty
  EOT</span>
  <span class="ruby-identifier">sales</span> = <span class="ruby-constant">Sale</span>.<span class="ruby-identifier">select</span>(<span class="ruby-identifier">sel</span>).
        <span class="ruby-identifier">joins</span>(<span class="ruby-string">&#39;AS s INNER JOIN games AS g ON s.game_id = g.id&#39;</span>).
        <span class="ruby-identifier">joins</span>(<span class="ruby-string">&#39;INNER JOIN terminals AS t ON s.terminal_id = t.id&#39;</span>).
        <span class="ruby-identifier">where</span>(<span class="ruby-string">&#39;s.date BETWEEN :from AND :to&#39;</span>, <span class="ruby-identifier">from</span><span class="ruby-operator">:</span> <span class="ruby-identifier">c</span>[<span class="ruby-value">:from</span>], <span class="ruby-identifier">to</span><span class="ruby-operator">:</span> <span class="ruby-identifier">c</span>[<span class="ruby-value">:to</span>])
  <span class="ruby-identifier">exclude</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">c</span>[<span class="ruby-value">:criteria</span>][<span class="ruby-value">:exclude</span>] <span class="ruby-keyword">then</span> <span class="ruby-string">&#39;NOT&#39;</span> <span class="ruby-keyword">else</span> <span class="ruby-string">&#39;&#39;</span> <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span>    <span class="ruby-identifier">c</span>[<span class="ruby-value">:criteria</span>][<span class="ruby-value">:key</span>] <span class="ruby-operator">=~</span> <span class="ruby-regexp">/agents?/</span>
    <span class="ruby-identifier">sales</span> = <span class="ruby-identifier">sales</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&#39;t.agent_id &#39;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">exclude</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39; IN (:items)&#39;</span>, 
              <span class="ruby-identifier">items</span><span class="ruby-operator">:</span> <span class="ruby-identifier">c</span>[<span class="ruby-value">:criteria</span>][<span class="ruby-value">:items</span>])
  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">c</span>[<span class="ruby-value">:criteria</span>][<span class="ruby-value">:key</span>] <span class="ruby-operator">=~</span> <span class="ruby-regexp">/terminals?/</span>
    <span class="ruby-identifier">sales</span> = <span class="ruby-identifier">sales</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&#39;t.id &#39;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">exclude</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39; IN (:items)&#39;</span>, 
              <span class="ruby-identifier">items</span><span class="ruby-operator">:</span> <span class="ruby-identifier">c</span>[<span class="ruby-value">:criteria</span>][<span class="ruby-value">:items</span>])
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">sales</span> = <span class="ruby-identifier">sales</span>.<span class="ruby-identifier">group</span>(<span class="ruby-string">&#39;g.id&#39;</span>).<span class="ruby-identifier">having</span>(<span class="ruby-string">&#39;qty &gt; 0&#39;</span>).<span class="ruby-identifier">order</span>(<span class="ruby-string">&#39;is_instant, parent_id, g.id&#39;</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-last_day_of_month" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">last_day_of_month</span><span
            class="method-args">(d)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>return last day of month for given data</p>
          
          

          
          <div class="method-source-code" id="last_day_of_month-source">
            <pre><span class="ruby-comment"># File lib/comp/utils.rb, line 69</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">last_day_of_month</span>(<span class="ruby-identifier">d</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;#{ d } is not a date&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">d</span>.<span class="ruby-identifier">instance_of?</span> <span class="ruby-constant">Date</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">d</span>.<span class="ruby-identifier">month</span> <span class="ruby-operator">==</span> <span class="ruby-value">12</span>
    (<span class="ruby-constant">Date</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">d</span>.<span class="ruby-identifier">year</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>, <span class="ruby-value">1</span>, <span class="ruby-value">1</span>) <span class="ruby-operator">-</span> <span class="ruby-value">1</span>
  <span class="ruby-keyword">else</span>
    (<span class="ruby-constant">Date</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">d</span>.<span class="ruby-identifier">year</span>, <span class="ruby-identifier">d</span>.<span class="ruby-identifier">month</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>, <span class="ruby-value">1</span>) <span class="ruby-operator">-</span> <span class="ruby-value">1</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-month_ago" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">month_ago</span><span
            class="method-args">(period)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Compare every 7th day</p>
          
          

          
          <div class="method-source-code" id="month_ago-source">
            <pre><span class="ruby-comment"># File lib/comp/utils.rb, line 81</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">month_ago</span>(<span class="ruby-identifier">period</span>)
  <span class="ruby-identifier">year</span> = <span class="ruby-identifier">period</span>[<span class="ruby-value">:from</span>].<span class="ruby-identifier">year</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">period</span>[<span class="ruby-value">:from</span>].<span class="ruby-identifier">month</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
    <span class="ruby-identifier">year</span>  = <span class="ruby-identifier">year</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>
    <span class="ruby-identifier">month</span> = <span class="ruby-value">12</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">month</span> = <span class="ruby-identifier">period</span>[<span class="ruby-value">:from</span>].<span class="ruby-identifier">month</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>
  <span class="ruby-keyword">end</span>
  {
    <span class="ruby-identifier">from</span><span class="ruby-operator">:</span> <span class="ruby-constant">Date</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">year</span>, <span class="ruby-identifier">month</span>, <span class="ruby-identifier">period</span>[<span class="ruby-value">:from</span>].<span class="ruby-identifier">day</span>),
    <span class="ruby-identifier">to</span><span class="ruby-operator">:</span>   <span class="ruby-constant">Date</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">year</span>, <span class="ruby-identifier">month</span>, <span class="ruby-identifier">period</span>[<span class="ruby-value">:to</span>].<span class="ruby-identifier">day</span>)
  }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-year_ago" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">year_ago</span><span
            class="method-args">(period)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="year_ago-source">
            <pre><span class="ruby-comment"># File lib/comp/utils.rb, line 95</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">year_ago</span>(<span class="ruby-identifier">period</span>)
  {
    <span class="ruby-identifier">from</span><span class="ruby-operator">:</span> <span class="ruby-constant">Date</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">period</span>[<span class="ruby-value">:from</span>].<span class="ruby-identifier">year</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>, <span class="ruby-identifier">period</span>[<span class="ruby-value">:from</span>].<span class="ruby-identifier">month</span>, <span class="ruby-identifier">period</span>[<span class="ruby-value">:from</span>].<span class="ruby-identifier">day</span>),
    <span class="ruby-identifier">to</span><span class="ruby-operator">:</span>   <span class="ruby-constant">Date</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">period</span>[<span class="ruby-value">:to</span>].<span class="ruby-identifier">year</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>, <span class="ruby-identifier">period</span>[<span class="ruby-value">:to</span>].<span class="ruby-identifier">month</span>, <span class="ruby-identifier">period</span>[<span class="ruby-value">:to</span>].<span class="ruby-identifier">day</span>)
  }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>
</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="http://docs.seattlerb.org/rdoc/">RDoc</a> 4.2.2.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

